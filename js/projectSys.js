const firebaseConfig={apiKey:"AIzaSyCI4i-fFdg9ca86jtLgT4d1yqPkE5Xylng",authDomain:"experience-builder-m-v-wxacv7.firebaseapp.com",projectId:"experience-builder-m-v-wxacv7",storageBucket:"experience-builder-m-v-wxacv7.appspot.com",messagingSenderId:"940965852397",appId:"1:940965852397:web:b00fb6ccd9ff65aed748e4"};firebase.initializeApp(firebaseConfig);const storage=firebase.storage(),db=firebase.firestore(),auth=firebase.auth(),startFirebaseUI=()=>{const e=new firebaseui.auth.AuthUI(firebase.auth()),t={signInOptions:[{provider:firebase.auth.GoogleAuthProvider.PROVIDER_ID,scopes:["profile","email"]},{provider:firebase.auth.EmailAuthProvider.PROVIDER_ID,signInMethod:firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD,requireDisplayName:!0,disableSignUp:{status:!1},allowSignUp:!0}],signInFlow:"popup",credentialHelper:firebaseui.auth.CredentialHelper.NONE,signInSuccessUrl:window.location.href,callbacks:{signInSuccessWithAuthResult:e=>!1,signInFailure:e=>{console.error("Sign in failed:",e)}},tosUrl:"/tos",privacyPolicyUrl:"/privacy-policy"};e.start("#firebaseui-auth-container",t)};function showAuthModal(e="Log in or Sign Up",t="Create faster with <i>Dlightning⚡</i>"){if(!document.getElementById("auth-modal")){const o=`\n            <div style="text-align: center;" id="auth-modal" class="modal">\n                <div class="modal-content">\n                    <button class="close-modal">&times;</button>\n                    <h2>${e}</h2>\n                    <p style="color: var(--basic-txt-color)">${t}</p>\n                    <br>\n                    <div id="firebaseui-auth-container"></div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",o),startFirebaseUI(),document.querySelector("#auth-modal .close-modal").addEventListener("click",hideAuthModal)}document.getElementById("auth-modal").style.display="flex"}function hideAuthModal(){const e=document.getElementById("auth-modal");e&&(e.style.display="none")}document.addEventListener("keydown",(e=>{"Escape"===e.key&&hideAuthModal()}));const initAuth=()=>{document.createElement("div").id="firebaseui-auth-container";const e=new firebaseui.auth.AuthUI(firebase.auth()),t={signInOptions:[firebase.auth.GoogleAuthProvider.PROVIDER_ID,{provider:firebase.auth.EmailAuthProvider.PROVIDER_ID,signInMethod:firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD,requireDisplayName:!0,allowSignUp:!0}],credentialHelper:firebaseui.auth.CredentialHelper.NONE,callbacks:{signInSuccessWithAuthResult:e=>(initUserData(e.user),!1)}};e.start("#firebaseui-auth-container",t)};class ProImageStorageManager{constructor(){this.storage=firebase.storage(),this.storageRef=this.storage.ref(),this.db=firebase.firestore(),this.maxImageSize=1048576}async handleImageUpload(e,t,o,r=null){try{if(!await this.checkProAccess(o))throw new Error("Pro account required for image storage");if(r&&r.includes("firebasestorage.googleapis.com"))try{const e=this.storage.refFromURL(r);await e.delete();const o=await this.db.collection("project_images").where("storageUrl","==",r).where("projectId","==",t).limit(1).get();o.empty||await o.docs[0].ref.delete()}catch(e){console.warn("Error deleting old image:",e)}const n=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;let a=e;e.size>this.maxImageSize&&(a=await this.compressImage(e));const s=this.storageRef.child(`projects/${t}/images/${n}`),i=await s.put(a),c=await i.ref.getDownloadURL();return await this.db.collection("project_images").add({projectId:t,imageId:n,fileName:e.name||"image",storageUrl:c,size:a.size,uploadedBy:o,createdAt:firebase.firestore.FieldValue.serverTimestamp()}),{imageId:n,url:c}}catch(e){throw console.error("Error handling image upload:",e),e}}async checkProAccess(e){try{const t=await this.db.collection("users").doc(e).get();return t.exists&&!0===t.data().pro_account}catch(e){return console.error("Error checking pro access:",e),!1}}async compressImage(e){return new Promise((t=>{const o=new FileReader;o.onload=e=>{const o=new Image;o.onload=()=>{const e=document.createElement("canvas");let r=o.width,n=o.height;(r>1920||n>1920)&&(r>n?(n=n/r*1920,r=1920):(r=r/n*1920,n=1920)),e.width=r,e.height=n;const a=e.getContext("2d");a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(o,0,0,r,n),e.toBlob((e=>t(e)),"image/jpeg",.85)},o.src=e.target.result},o.readAsDataURL(e)}))}catch(e){throw console.error("Detailed upload error:",{error:e,userId:userId,projectId:projectId,errorCode:e.code,errorMessage:e.message}),e}}const imageManager=new ProImageStorageManager;class ProjectManager{constructor(){this.currentUser=null,this.currentProject=null,this.db=firebase.firestore(),this.autoSaveInterval=null,this.contentChanged=!1,this.setupChangeDetection(),this.initAuthListener(),this.initEventListeners(),this.setupColorChangeListener()}initEventListeners(){document.getElementById("new-project-btn").addEventListener("click",(()=>{this.checkProjectLimit()}))}async handleNewProject(){if(!this.currentUser)return void showAuthModal("Log in or Sign Up to Save Projects","Create more with Dlightning");const e=document.getElementById("new-project-btn").closest(".modal");e&&hideModal(e.id);try{const e=document.querySelectorAll(".canvas-wrapper");if(e.length>0&&!this.currentProject){if(await showConfirmDialog("You have unsaved screens. Would you like to save them to your new project?",{heading:"Save Current Screens",confirmText:"Add Screens",cancelText:"No, Thanks"})){const e=await showPromptDialog("Name your project","Untitled Project",{heading:"New Project",confirmText:"Create",cancelText:"Cancel"});if(!e)return;const t=firebase.firestore.FieldValue.serverTimestamp(),o=await this.db.collection("project").add({project_name:e,owner:this.db.doc(`users/${this.currentUser.uid}`),description:"",complete_percent:0,img_hero_proj:"https://firebasestorage.googleapis.com/v0/b/experience-builder-m-v-wxacv7.appspot.com/o/noisy-gradients-lighter-sm.png?alt=media&token=947bbdf8-1752-4be0-b6e8-b15cf1c23556",last_edited:t,pinned_project:!1,private:!1,start_date:t,user_role:["-"],users_assigned:[this.db.doc(`users/${this.currentUser.uid}`)],time_created:t});this.currentProject={id:o.id,name:e};const r=document.querySelector("#project-title h3");r&&(r.textContent=e,r.style.display="block"),this.contentChanged=!0,await this.saveCanvases(),this.setupAutoSave(),hideModal("projects-modal"),this.showNotification("Project created with existing screens!"),await this.loadUserProjects()}else{e.forEach((e=>e.remove())),editor.resetCanvasCount(),editor.createNewCanvas();const t=await showPromptDialog("Name your project","Untitled Project",{heading:"New Project",confirmText:"Create",cancelText:"Cancel"});if(!t)return;await this.createNewProject(t)}}else{const e=await showPromptDialog("Name your project","Untitled Project",{heading:"New Project",confirmText:"Create",cancelText:"Cancel"});if(!e)return;await this.createNewProject(e)}}catch(e){console.error("Error handling new project:",e),this.showNotification("Error creating new project","error")}}async createNewProject(e){try{const t=firebase.firestore.FieldValue.serverTimestamp(),o=await this.db.collection("project").add({project_name:e,owner:this.db.doc(`users/${this.currentUser.uid}`),description:"",complete_percent:0,img_hero_proj:"https://firebasestorage.googleapis.com/v0/b/experience-builder-m-v-wxacv7.appspot.com/o/noisy-gradients-lighter-sm.png?alt=media&token=947bbdf8-1752-4be0-b6e8-b15cf1c23556",last_edited:t,pinned_project:!1,private:!1,start_date:t,user_role:["-"],users_assigned:[this.db.doc(`users/${this.currentUser.uid}`)],time_created:t,canvases:[{index:0,content:"",hasTopNav:!1,hasBottomNav:!1}]});this.currentProject={id:o.id,name:e};const r=document.querySelector("#project-title h3");if(r&&(r.textContent=e,r.style.display="block"),document.querySelectorAll(".canvas-wrapper").forEach((e=>e.remove())),!editor)return console.error("Editor not found"),void this.showNotification("Error initializing screen(s)","error");{editor.createNewCanvas(),await new Promise((e=>setTimeout(e,100)));const e=document.querySelector(".canvas");if(e)e.classList.add("selected"),editor.state.selectedCanvases.add(e),e.addEventListener("click",(e=>editor.handleCanvasSelection(e)));else{console.warn("Canvas element not found after creation, will retry..."),await new Promise((e=>setTimeout(e,300)));const e=document.querySelector(".canvas");e?(e.classList.add("selected"),editor.state.selectedCanvases.add(e),e.addEventListener("click",(e=>editor.handleCanvasSelection(e)))):console.error("Could not find canvas element after retry")}}this.setupAutoSave(),hideModal("projects-modal"),this.showNotification("Project created successfully!"),await this.loadUserProjects();const n=document.querySelector(".save-canvas-btn");n&&(n.style.display="block")}catch(e){console.error("Error creating project:",e),this.showNotification("Error creating project","error")}}showSubscriptionModal(e,t,o){const r=document.querySelector("#subscription-modal");r&&r.remove();const n=document.createElement("div");n.className="modal subscription-modal",n.id="subscription-modal",n.innerHTML=`\n            <div class="modal-content">\n                <h2>${e}</h2>\n                <p>${t}</p>\n\n                <div style="display: flex; justify-content: space-between; align-items: flex-end; gap: 12px;">\n                    <ul class="features-list">\n                        <lable><b>Subscription Features Include</b></lable>\n                        <li>Unlimited projects and screens</li>\n                        <li>Early Access to new components</li>\n                        <li>Image saving abilities</li>\n                    </ul>\n                </div>\n\n                <div class="subscription-cards">\n                    <div class="subscription-card" data-plan="monthly" onclick="projectManager.selectPlan(this)">\n                        <h3>1 Month Subscription</h3>\n                        <div class="price">$8.00</div>\n                        <div class="price-subtext">¢27/day</div>\n                    </div>\n                    \n                    <div class="subscription-card" data-plan="yearly" onclick="projectManager.selectPlan(this)">\n                        <h3>1 Year Subscription</h3>\n                        <div class="price">$72.00</div>\n                        <div class="price-subtext">$6.00/month</div>\n                    </div>\n                </div>\n                <div class="modal-buttons">\n                    <button onclick="projectManager.handleSubscriptionPurchase(this)">Subscribe Now &emsp;<i class="fas fa-arrow-up-right-from-square"></i></button>\n                    <button onclick="this.closest('.modal').remove()">Cancel</button>\n                </div>\n                <img src="img/stripe-logo.svg" style="width: 86px; margin: 0 -24px -34px 0; float: right;">\n            </div>\n        `,document.body.appendChild(n),n.style.display="flex"}selectPlan(e){e.parentElement.querySelectorAll(".subscription-card").forEach((e=>e.classList.remove("selected"))),e.classList.add("selected")}async handleSubscriptionPurchase(e){const t=e.closest(".modal").querySelector(".subscription-card.selected");if(t)try{e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...';const o=t.dataset.plan,r=firebase.auth().currentUser;if(!r)throw new Error("User not authenticated");try{await r.getIdToken(!0),console.log("Auth token refreshed successfully")}catch(e){throw console.error("Token refresh failed:",e),new Error(`Authentication error: ${e.message}`)}const n=window.location.origin+window.location.pathname,a=`${n}?subscription=success`,s=`${n}?subscription=cancel`,i=new StripeClientHandler;this.showNotification("Preparing checkout...","info");const c=i.handleSubscription(r,r.email,o,a,s),l=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Connection timeout - please try again"))),15e3)})),d=await Promise.race([c,l]);if(!d||"string"!=typeof d)throw new Error("Invalid checkout URL received");console.log("Redirecting to checkout:",d),this.showNotification("Redirecting to Stripe...","info"),window.location.href=d}catch(t){console.error("Subscription error:",t);let o=t.message||"Please try again";o.includes("CORS")||o.includes("Network Error")?o="Connection issue. Please try again later.":o.includes("internal")||o.includes("Server error")?o="Server issue. Please try again later.":o.includes("timeout")&&(o="Connection timeout. Please check your internet and try again."),this.showNotification("❌ "+o,"error"),e.disabled=!1,e.textContent="Subscribe Now"}else this.showNotification("Please select a subscription plan","warning")}checkSubscriptionStatus(){const e=new URLSearchParams(window.location.search).get("subscription");"success"===e?(this.showNotification("✅ Subscription successful!","success"),window.history.replaceState(null,"",window.location.pathname),setTimeout((()=>{this.refreshUserStatus()}),2e3)):"cancel"===e&&(this.showNotification("❌ Subscription process canceled.","error"),window.history.replaceState(null,"",window.location.pathname))}async refreshUserStatus(){try{if(!firebase.auth().currentUser)return;const e=await firebase.firestore().collection("users").doc(firebase.auth().currentUser.uid).get();e.exists&&e.data().pro_account&&this.showNotification("✨ Pro features activated!","success")}catch(e){console.error("Error refreshing user status:",e)}}showNotification(e,t="success"){const o=document.createElement("div");o.className=`notification ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.remove()}),3800)}async getUserProjectCount(){return(await this.db.collection("projects").where("owner","==",this.currentUser.uid).get()).size}initAuthListener(){firebase.auth().onAuthStateChanged((async e=>{if(this.currentUser=e,e)this.loadUserProjects();else{this.clearAutoSave();const e=document.querySelector("#project-title h3");e&&(e.style.display="none")}}))}getCurrentColors(){const e=getComputedStyle(document.documentElement);return{primary:e.getPropertyValue("--color-primary").trim(),secondary:e.getPropertyValue("--color-secondary").trim(),accent:e.getPropertyValue("--color-accent").trim()}}saveProjectColors(){if(this.currentProject?.id&&!this.isSavingColors)try{const e=this.getCurrentColors(),t=JSON.parse(localStorage.getItem(`projectColors_${this.currentProject.id}`));if(t&&this.areColorsEqual(t,e))return;this.isSavingColors=!0,localStorage.setItem(`projectColors_${this.currentProject.id}`,JSON.stringify(e)),this.pendingUpdates={...this.pendingUpdates,colors:{...e,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()}},this.pendingWriteTimer||(this.pendingWriteTimer=setTimeout((()=>{this.flushPendingUpdates()}),8e3))}catch(e){}finally{this.isSavingColors=!1}}async flushPendingUpdates(){if(this.pendingUpdates&&this.currentProject?.id)try{const e=this.db.collection("project").doc(this.currentProject.id);await e.update(this.pendingUpdates),this.pendingUpdates={},this.pendingWriteTimer=null,this.isSavingColors=!1}catch(e){console.error("Error saving color updates:",e),this.isSavingColors=!1}else this.pendingWriteTimer=null}async loadProjectColors(e){try{const t=await this.db.collection("project").doc(e).get();if(!t.exists)return;const o=t.data().colors,r=o||{primary:"#3498db",secondary:"#5f615d",accent:"#fbd513"};document.documentElement.style.setProperty("--color-primary",r.primary),document.documentElement.style.setProperty("--primary-color",r.primary),document.documentElement.style.setProperty("--color-secondary",r.secondary),document.documentElement.style.setProperty("--color-accent",r.accent),window.colorPicker&&(colorPicker.colors[0].hexString=r.primary,colorPicker.colors[1].hexString=r.secondary,colorPicker.colors[2].hexString=r.accent)}catch(e){console.error("Error loading project colors:",e),document.documentElement.style.setProperty("--color-primary","#3498db"),document.documentElement.style.setProperty("--primary-color","#3498db"),document.documentElement.style.setProperty("--color-secondary","#5f615d"),document.documentElement.style.setProperty("--color-accent","#fbd513")}}async handleCanvasDelete(e){if(this.currentProject?.id)try{this.clearAutoSave(),this.markAllCanvasesChanged("Canvas deletion");const t=firebase.firestore().collection("project").doc(this.currentProject.id),o=await t.collection("saved_screens").orderBy("index").get(),r=firebase.firestore().batch(),n=t.collection("saved_screens").doc(`screen_${e}`);r.delete(n);const a=o.docs.filter((t=>t.data().index>e));a.forEach((e=>{const t=e.data();r.update(e.ref,{index:t.index-1,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()})})),await r.commit(),console.log(`%cDeleted screen at index ${e} and updated ${a.length} subsequent screens`,"color: #3F51B5; font-weight: bold"),await t.update({last_edited:firebase.firestore.FieldValue.serverTimestamp()}),this.resetChangeTracking(),setTimeout((()=>{this.setupAutoSave()}),1e3)}catch(e){console.error("Error deleting canvas from database:",e),this.showNotification("Error deleting canvas from database","error"),this.setupAutoSave()}else console.warn("No active project found")}unwrapComponents(e){const t=document.createElement("div");t.innerHTML=e;const o=e=>{if(e.nodeType===Node.ELEMENT_NODE){if(e.classList&&e.classList.contains("component-container")&&"table"===e.getAttribute("data-component-type")){const t=e.querySelector(".component-content"),o=t?.querySelector(".data-table-scroll-wrapper");if(t&&o){const t=o.innerHTML,r=document.createElement("div");return r.setAttribute("data-component-type","table"),r.setAttribute("data-top-level-component","true"),r.setAttribute("data-table-content",encodeURIComponent(t)),void e.replaceWith(r)}}if(e.classList&&e.classList.contains("component-container")){const t=e.getAttribute("data-component-type"),o=e.querySelector(".component-content")?.firstElementChild;if(o&&t){o.setAttribute("data-component-type",t);const r=e.querySelector(".component-content");return r?.dataset.currentVariant&&o.setAttribute("data-current-variant",r.dataset.currentVariant),r?.dataset.cachedVariants&&o.setAttribute("data-cached-variants",r.dataset.cachedVariants),o.setAttribute("data-top-level-component","true"),void e.replaceWith(o)}}if(e.children&&e.children.length){Array.from(e.children).forEach((e=>o(e)))}}};return Array.from(t.children).forEach((e=>o(e))),t.innerHTML}async loadProject(e){try{if(!e)throw new Error("No project ID provided");const t=await this.db.collection("project").doc(e).get();if(!t.exists)return void this.showNotification("Project not found","error");const o=await this.db.collection("project").doc(e).collection("saved_screens").get(),r=t.data(),n=document.querySelectorAll(".canvas-wrapper");if(o.empty&&n.length>0){if(await showConfirmDialog("This project has no screens. Would you like to add your current unsaved screens to this project?",{heading:"Add Current Screens",confirmText:"Add Screens",cancelText:"No, Thanks"})){const t=document.querySelector("#project-title h3");t&&(t.textContent=r.project_name,t.style.display="block"),this.currentProject={id:e,name:r.project_name},this.contentChanged=!0,await this.saveCanvases(),this.setupAutoSave(),await this.loadProjectColors(e),await this.loadProjectFonts(e),hideModal("projects-modal"),this.showNotification("Screens added to project successfully");const o=document.querySelector(".save-canvas-btn");return void(o&&(o.style.display="block"))}}const a=document.querySelector("#project-title h3");a&&(a.textContent=r.project_name,a.style.display="block"),this.currentProject={id:e,name:r.project_name},await this.loadSavedCanvases(e),await this.loadProjectColors(e),await this.loadProjectFonts(e),hideModal("projects-modal");const s=document.querySelector(".save-canvas-btn");s&&(s.style.display="block"),this.showNotification("Project loaded successfully")}catch(e){console.error("Error loading project:",e),this.showNotification("Error loading project","error")}}setupColorChangeListener(){if(window.colorPicker){let e,t,o=this.getCurrentColors();const r=5e3;colorPicker.on("color:change",(n=>{e&&clearTimeout(e),t||(e=setTimeout((()=>{const e=this.getCurrentColors();this.areColorsEqual(o,e)||(this.saveProjectColors(),this.contentChanged=!0,o={...e},t=setTimeout((()=>{t=null}),r))}),2e3))}))}}areColorsEqual(e,t){return e.primary===t.primary&&e.secondary===t.secondary&&e.accent===t.accent}setupAutoSave(){this.autosaveInterval&&clearInterval(this.autosaveInterval),this.autosaveInterval=setInterval((()=>{this.currentProject&&this.contentChanged&&(this.saveCanvases(),this.contentChanged=!1)}),22e3),this.setupChangeDetection()}setupChangeDetection(){let e=null;this._changedCanvases=new Map;let t=!1;const o=new Set(["controls","component-handle","resize-handle","nav-control","alignment-controls","delete-canvas-btn","color-swatch-container","component-controls","drag-handle","alignment-arrow","text-alignment-controls","IroWheel","IroSlider","IroHandle"]),r=(new Set(["controls-hidden","controls-visible","selected","hovered","active","dragging","resizing","focused","disabled","success-drop","selected-drag","controls-hidden","duplicate-animation","component-add-animation"]),new Set(["opacity","visibility","display","transition","pointer-events","cursor","z-index","outline","user-select","position","transform","background-color","--color-primary","--color-secondary","--color-accent","--primary-color"])),n=e=>e.closest(".canvas-wrapper"),a=e=>e?.getAttribute("data-canvas-id")||null,s=(o,r,n)=>{o&&(e&&clearTimeout(e),e=setTimeout((()=>{this.addCanvasToChanged(o,`${r}: ${JSON.stringify(n).slice(0,100)}`),t=!0}),3500))},i=e=>{if(!e||!e.classList)return!1;if(e.closest(".IroColorPicker")||e.closest(".IroWheel")||e.closest(".IroSlider"))return!0;for(const t of e.classList)if(o.has(t))return!0;let t=e.parentElement,r=0;for(;t&&r<3;){for(const e of t.classList)if(o.has(e))return!0;t=t.parentElement,r++}return e.matches?.('button, .controls *, [class*="handle"], .modal *, .tooltip *, .popup *')};document.addEventListener("click",(e=>{if(e.eventPhase!==Event.BUBBLING_PHASE)return;const o=e.target.closest(".component-btn, .duplicate-btn, .delete-btn, .color-swatch, .nav-control");if(o){const r=n(o),i=a(r);i&&(t=!0,e.stopPropagation(),s(i,"User interaction",{type:"Button click",element:o.className,action:o.classList.contains("nav-control")?"Navigation control":"Component interaction"}))}}),!1);const c=e=>{const o=a(e);if(!o)return;const n=new MutationObserver((e=>{if(e.some((e=>{const t=e.target.nodeType===Node.TEXT_NODE?e.target.parentElement:e.target,o=t?.closest?.(".component-btn, .duplicate-btn, .delete-btn, .color-swatch, .nav-control");return null!==o})))return;let n=[];e.some((e=>{const t=e.target.nodeType===Node.TEXT_NODE?e.target.parentElement:e.target;if(!t||i(t))return!1;switch(e.type){case"characterData":const t=e.target.parentElement,o=t?.hasAttribute("contenteditable");return o&&n.push({type:"Text content",element:t.tagName,oldValue:e.oldValue,newValue:e.target.textContent}),o;case"attributes":if("style"===e.attributeName){const t=((e,t)=>{const o=e=>{const t={};return e?(e.split(";").forEach((e=>{const[o,n]=e.split(":").map((e=>e?.trim()));o&&!r.has(o.toLowerCase())&&(t[o]=n)})),t):t},n=o(e||""),a=o(t||"");for(const e in{...n,...a})if(!r.has(e.toLowerCase())&&n[e]!==a[e])return!0;return!1})(e.oldValue,e.target.style.cssText);return t&&n.push({type:"Style change",element:e.target.tagName,oldStyle:e.oldValue,newStyle:e.target.style.cssText}),t}return!1;case"childList":const a=Array.from(e.addedNodes),s=Array.from(e.removedNodes);return[...a,...s].some((e=>{if(e.nodeType===Node.TEXT_NODE){const t=e.parentElement?.hasAttribute("contenteditable");return t&&n.push({type:"Text node change",parent:e.parentElement?.tagName,content:e.textContent?.slice(0,50)+"..."}),t}const t=e.nodeType===Node.ELEMENT_NODE&&!i(e);return t&&n.push({type:"DOM structure change",operation:a.includes(e)?"added":"removed",element:e.tagName||e.nodeName}),t}));default:return!1}}))&&(t=!0,s(o,"MutationObserver",n))}));return n.observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0,attributeOldValue:!0}),n};["input","paste","drop","dragend"].forEach((e=>{document.addEventListener(e,(o=>{if(!i(o.target)){const r=n(o.target),i=a(r);i&&(t=!0,s(i,"User input",{type:e,element:o.target.tagName,elementType:o.target.type||"N/A"}))}}),!0)})),document.querySelectorAll(".canvas-wrapper").forEach((e=>{e.hasAttribute("data-canvas-id")||e.setAttribute("data-canvas-id",`canvas_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),c(e)}));const l=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e.classList?.contains("canvas-wrapper")&&(e.hasAttribute("data-canvas-id")||e.setAttribute("data-canvas-id",`canvas_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),c(e))}))}))})),d=document.querySelector("#mockZone");d&&l.observe(d,{childList:!0}),this.getChangedCanvases=()=>Array.from(this._changedCanvases.keys()),this.hasUnsavedChanges=()=>t&&this.contentChanged,this.resetChangeTracking=()=>{t=!1,this.contentChanged=!1,this._changedCanvases.clear()}}addCanvasToChanged(e,t){e&&(this._changedCanvases||(this._changedCanvases=new Map),this._changedCanvases.has(e)||this._changedCanvases.set(e,[]),this._changedCanvases.get(e).push({type:"Change tracking",timestamp:(new Date).toISOString(),details:t||"Component change"}),this.contentChanged=!0,console.log(`%cCanvas ${e} marked for saving: ${t}`,"color: #FF5722; font-weight: bold"))}async saveCanvases(){return firebase.auth().currentUser&&this.currentProject?.id&&this.contentChanged?this._savePromise?(console.log("Save already in progress, waiting for completion"),this._savePromise):(this._savePromise=(async()=>{try{this.saveProjectColors();const e=this.getChangedCanvases(),t=(new Date).toLocaleString(),o=this.db.collection("project").doc(this.currentProject.id),r=o.collection("saved_screens"),n=new ProImageStorageManager,a=await n.checkProAccess(this.currentUser.uid),s=document.querySelector(".canvas-timestamp");s&&(s.textContent="Saving...",s.classList.add("pulseAnim"));const i=document.querySelectorAll(".canvas-wrapper"),c=await r.get(),l=new Map;c.forEach((e=>{l.set(e.id,e.data())}));const d=firebase.firestore().batch(),u=new Map;Array.from(i).forEach(((e,t)=>{const o=e.getAttribute("data-canvas-id");o&&u.set(o,t+1)}));const p=[];l.forEach(((e,t)=>{Array.from(i).some((o=>`screen_${e.index}`===t))||(p.push(t),d.delete(r.doc(t)),console.log(`%cMarking screen ${t} for deletion (no longer in DOM)`,"color: #FF5722; font-weight: bold"))}));const h=Array.from(i).map((async(t,o)=>{const n=t.getAttribute("data-canvas-id"),s=o+1,i=`screen_${s}`,c=l.get(i),d=e.includes(n),u=!c||c.index!==s;if(!d&&!u)return null;const p=t.querySelector(".canvas-content");if(!p)return null;let h;if(d){const e=document.createElement("div");e.innerHTML=p.innerHTML;const t=e.querySelectorAll(".card-image, .nav-image");for(const e of t){if(e.style.backgroundImage){if("none"===e.style.backgroundImage)continue;const t=e.style.backgroundImage.replace(/^url\(['"]?/,"").replace(/['"]?\)$/,"");if(t){if(!a){e.style.backgroundImage="",e.style.backgroundColor="var(--neutral-gray)",e.innerHTML='<i class="fas fa-image" style="color: var(--placeholder-color);"></i><span class="imgMsg non-editable">Click to add image</span>',e.classList.add("had-image");continue}t.startsWith("data:")?(console.warn("Found data URL image for pro user - removing to avoid document size issues"),e.style.backgroundImage="",e.style.backgroundColor="var(--neutral-gray)",e.innerHTML='<i class="fas fa-image" style="color: var(--placeholder-color);"></i><span class="imgMsg non-editable">Click to add image</span>'):t.includes("firebasestorage.googleapis.com")&&(e.setAttribute("data-background-image",t),e.style.backgroundImage="",e.style.backgroundColor="var(--neutral-gray)")}}e.querySelectorAll('img[src^="data:"]').forEach((e=>{if(!a){const t=document.createElement("div");t.innerHTML='<i class="fas fa-image" style="color: var(--placeholder-color);"></i><span class="imgMsg non-editable">Click to add image</span>',e.parentNode.replaceChild(t,e)}}))}e.querySelectorAll('img[src^="data:"], *[style*="data:"]').forEach((e=>{if("IMG"===e.tagName){if(!a){const t=document.createElement("div");t.style.width="100%",t.style.height="100%",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.flexDirection="column",t.style.backgroundColor="var(--neutral-gray)",t.innerHTML='<i class="fas fa-image" style="color: var(--placeholder-color);"></i><span style="color: var(--placeholder-color); font-size: 14px; margin-top: 8px;">Image</span>',e.parentNode.replaceChild(t,e)}}else{const t=e.getAttribute("style");if(t){const o=t.replace(/url\(\s*['"]?data:[^)]+\)/g,"url()");e.setAttribute("style",o)}}}));const o=["script",".alignment-arrow",".color-swatch-container",".text-alignment-controls",".controls",".variant-controls",".resize-handle",".iconControls",".bullet-list-item-controls"];e.querySelectorAll(o.join(", ")).forEach((e=>e.remove())),e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((e=>{e.hasAttribute("contenteditable")||e.setAttribute("contenteditable","true")})),h=this.unwrapComponents(e.innerHTML)}const m={lastUpdated:firebase.firestore.FieldValue.serverTimestamp()};if(d){m.content=h;const e=t.querySelector(".canvas");if(e){Object.keys(editor.specialComponents).forEach((t=>{const o=`data-has-${t}`,r=e.hasAttribute(o)&&"true"===e.getAttribute(o),n=`has${t.charAt(0).toUpperCase()+t.slice(1)}`;if(m[n]=r,r){let o;switch(t){case"navbar":o=e.querySelector(".navContain");break;case"bottomNav":o=e.querySelector(".bottomNavContain");break;case"sidebar":o=e.querySelector(".sidebar-container");break;case"modal":o=e.querySelector(".modal-wrapper");break;case"floatingActionButton":o=e.querySelector(".fab-container");break;default:o=null}if(o){const e=o.cloneNode(!0);e.querySelectorAll(".color-swatch-container, .controls, .alignment-arrow, .alignment-controls, .resize-handle").forEach((e=>e.remove())),m[`${t}Content`]=e.outerHTML}else editor.specialComponents[t].content&&(m[`${t}Content`]=editor.specialComponents[t].content)}}))}if(e){const t=window.getComputedStyle(e),o=e.style.width?parseInt(e.style.width):parseInt(t.width),r=e.style.height?parseInt(e.style.height):parseInt(t.height);isNaN(o)||isNaN(r)||(m.width=o,m.height=r)}}m.index=s,d&&u?console.log(`%cUpdating screen ${i} content and index to ${s}`,"color: #4CAF50; font-weight: bold"):d?console.log(`%cUpdating screen ${i} content only`,"color: #2196F3; font-weight: bold"):u&&console.log(`%cUpdating screen ${i} index to ${s}`,"color: #FF9800; font-weight: bold");try{return l.has(i)?await r.doc(i).update(m):(m.content||(m.content="",Object.keys(editor.specialComponents).forEach((e=>{const t=`has${e.charAt(0).toUpperCase()+e.slice(1)}`;m[t]=!1}))),await r.doc(i).set(m)),n&&this._changedCanvases.delete(n),i}catch(e){throw console.error(`Error saving screen ${i}:`,e),e}}));return d._mutations&&d._mutations.length>0&&(await d.commit(),console.log("%cCommitted structural changes to database","color: #9C27B0; font-weight: bold")),await Promise.all(h),await o.update({last_edited:firebase.firestore.FieldValue.serverTimestamp(),lastSavedTimestamp:t}),console.log("%cAll canvases saved successfully","color: #4CAF50; font-weight: bold"),s&&(s.textContent=`${t}`,setTimeout((()=>{s.classList.remove("pulseAnim")}),1e3)),this.resetChangeTracking(),!0}catch(e){console.error("Error saving canvases:",e),console.error("Error details:",{code:e.code,message:e.message,stack:e.stack});const t=document.querySelector(".canvas-timestamp");throw t&&(t.textContent="Save failed! Retry...",t.classList.remove("pulseAnim")),e}finally{this._savePromise=null}})(),this._savePromise):(console.log("No user logged in, no project selected, or no content changed"),Promise.resolve())}clearAutoSave(){this.autosaveInterval&&(clearInterval(this.autosaveInterval),this.autosaveInterval=null),this.contentChanged=!1}updateCanvasNumbers(){const e=document.querySelectorAll(".canvas-wrapper");let t=!1;e.forEach(((e,o)=>{const r=e.querySelector(".canvas-number"),n=e.querySelector(".canvas"),a=editor.state.selectedCanvases.has(n);r&&(r.textContent=`Screen ${o+1}${a?" (Selected)":""}`);const s=o+1,i=parseInt(e.dataset.previousIndex||"0");if(e.dataset.currentIndex=s,i>0&&i!==s){const o=e.getAttribute("data-canvas-id");o&&this&&"function"==typeof this.addCanvasToChanged&&(this.addCanvasToChanged(o,`Index changed from ${i} to ${s}`),this.contentChanged=!0,t=!0,console.log(`%cCanvas ${o} changed index: ${i} → ${s}`,"color: #4CAF50; font-weight: bold"))}e.dataset.previousIndex=s})),t&&this&&"function"==typeof this.saveCanvases&&(this._reorderSaveTimeout&&clearTimeout(this._reorderSaveTimeout),this._reorderSaveTimeout=setTimeout((()=>{console.log("%cSaving after canvas reordering...","color: #2196F3; font-weight: bold"),this.markAllCanvasesChanged("Canvas reordering"),this.saveCanvases().catch((e=>{console.error("Error saving after reordering:",e)}))}),1e3))}markAllCanvasesChanged(e){console.log(`%cMarking all canvases changed: ${e}`,"color: #E91E63; font-weight: bold");document.querySelectorAll(".canvas-wrapper").forEach((t=>{const o=t.getAttribute("data-canvas-id");o&&this.addCanvasToChanged(o,e)})),this.contentChanged=!0,clearTimeout(this._reorderSaveTimeout),this._reorderSaveTimeout=setTimeout((()=>{this.saveCanvases().catch((e=>{console.error("Error saving after reordering:",e)}))}),2e3)}rewrapComponents(e){const t=document.createElement("div");t.innerHTML=e;const o=(e,t)=>e.hasAttribute(t)?e.getAttribute(t):null,r=e=>{e.querySelectorAll('[data-top-level-component="true"]').forEach((e=>{if((t=e).parentElement&&t.parentElement.classList&&t.parentElement.classList.contains("component-content")&&t.parentElement.parentElement&&t.parentElement.parentElement.classList&&t.parentElement.parentElement.classList.contains("component-container"))return;var t;const r=o(e,"data-component-type");if(!r)return;if("table"===r){const t=o(e,"data-table-content");if(t)try{const o=editor.components.table(),r=editor.wrapComponentInContainer(o,"table",!0),n=r.querySelector(".data-table-scroll-wrapper");return n&&(n.innerHTML=decodeURIComponent(t),setTimeout((()=>{const e=r.querySelector(".component-content");if(e&&"function"==typeof editor.setupTable){editor.setupTable(e);const t=e.querySelector(".data-table-main");t&&(t.querySelectorAll(".fa-square").forEach((e=>{e.addEventListener("click",(()=>{const t=e.querySelector(".fa-square-check");t&&(t.style.display="none"===t.style.display?"block":"none")}))})),t.querySelectorAll(".row-controls").forEach((e=>{const t=e.closest("tr");t&&(t.addEventListener("mouseenter",(()=>{e.style.display="flex"})),t.addEventListener("mouseleave",(()=>{e.style.display="none"})),e.addEventListener("click",(()=>{t.remove()})))})))}}),100)),void e.replaceWith(r)}catch(e){console.error("Error restoring table component:",e)}}e.removeAttribute("data-top-level-component");const n=o(e,"data-current-variant"),a=o(e,"data-cached-variants");let s;e.removeAttribute("data-component-type"),n&&e.removeAttribute("data-current-variant"),a&&e.removeAttribute("data-cached-variants");try{if(editor.components[r]){const t=editor.components[r](e);s=editor.wrapComponentInContainer(t,r,!0)}else s=editor.wrapComponentInContainer(e,r,!0);if(s&&(n||a)){const e=s.querySelector(".component-content");e&&(n&&(e.dataset.currentVariant=n),a&&(e.dataset.cachedVariants=a))}s&&e.replaceWith(s)}catch(e){console.error(`Error wrapping component of type ${r}:`,e)}}));e.querySelectorAll(".blank-card-content, .colorBlock-inner, .accordion-content, .column-container").forEach((e=>{r(e)}))};return r(t),t.innerHTML}async loadSavedCanvases(e){try{editor&&editor.resetCanvasCount(),editor.state.selectedCanvases.clear();const t=await this.db.collection("project").doc(e).get();if(!t.exists)return void console.log("No saved project found");const o=t.data();document.querySelectorAll(".canvas-wrapper").forEach((e=>e.remove()));const r=await this.db.collection("project").doc(e).collection("saved_screens").get();if(r.empty){console.log("No saved screens found, creating a new canvas."),editor.createNewCanvas(),await new Promise((e=>setTimeout(e,50)));const t=document.querySelector(".canvas-wrapper");if(t){const e=t.querySelector(".canvas-content");e&&(editor.setupImageUpload(e),editor.setupIconPicker(e),editor.initializeSortable(e))}return this.currentProject={id:e,name:o.project_name},this.loadProjectFonts(e),console.log("Setting up autosave for new project canvas"),void setTimeout((()=>{this.setupAutoSave()}),1e3)}const n=[];r.forEach((e=>{n.push(e.data())}));const a=n.sort(((e,t)=>e.index-t.index));for(const[e,t]of a.entries()){editor.createNewCanvas(),await new Promise((e=>setTimeout(e,50)));const o=document.querySelectorAll(".canvas-wrapper"),r=o[o.length-1];if(!r){console.error("Canvas wrapper not found after creation");continue}const n=r.querySelector(".canvas");if(n&&t.width&&t.height){n.style.width=`${t.width}px`,n.style.height=`${t.height}px`;const e=r.querySelector(".dimensions");e&&(e.textContent=`${t.width-6} × ${t.height-6}`);const o=new Event("resize");window.dispatchEvent(o)}else console.log(`No saved dimensions for screen ${e+1}, using defaults`);const a=e=>{const t=document.createElement("div");t.innerHTML=e;var o;return(o=t).querySelectorAll("[data-component-type]").forEach((e=>{const t=e.closest("[data-component-type]");if(t&&t!==e){const o=e.getAttribute("data-component-type");if(!e.closest(".blank-card-content, .colorBlock-inner, .accordion-content, .column-container")&&o){console.log(`%cFixing incorrectly nested ${o} component`,"color: #FF9800; font-weight: bold");const r=t.closest(".component-container")||t;r.parentNode.insertBefore(e,r.nextSibling)}}let r=e,n=e.parentElement;for(;n&&n!==o&&"DIV"===n.tagName&&!n.getAttribute("data-component-type")&&!n.classList.contains("component-content")&&!n.classList.contains("component-container")&&!n.classList.contains("blank-card-content")&&!n.classList.contains("colorBlock-inner")&&!n.classList.contains("accordion-content")&&!n.classList.contains("column-container")&&1===n.childNodes.length;){const t=n.getAttribute("style")||"";if(t){const o=e.getAttribute("style")||"";e.setAttribute("style",`${o}; ${t}`)}const o=n.parentNode;o.replaceChild(r,n),n=o}})),t.innerHTML},s=r.querySelector(".canvas-content");if(s){const e=a(t.content||""),o=this.rewrapComponents(e);s.innerHTML=o,s.querySelectorAll(".card-image, .nav-image").forEach((e=>{const t=e.getAttribute("data-background-image");t&&(e.style.backgroundImage=`url(${t})`,e.removeAttribute("data-background-image"))}));Object.keys(editor.specialComponents).forEach((e=>{const o=`has${e.charAt(0).toUpperCase()+e.slice(1)}`,r=`${e}Content`;if(t[o]){let o;if(n.setAttribute(`data-has-${e}`,"true"),t[r]){const n=document.createElement("div");n.innerHTML=t[r],o=n.firstElementChild,editor.specialComponents[e].content=t[r],editor.specialComponents[e].added=!0,o||(console.error(`Failed to parse saved ${e} content`),o=editor.components[e]())}else o=editor.components[e](),console.log(`Creating new ${e} (no saved content)`);o&&(editor.insertSpecialComponent(n,o,e),"modal"===e?editor.setupModal(o):"bottomNav"===e?editor.setupBottomNav(o):"navbar"===e?editor.setupNavbar(o):"floatingActionButton"===e?editor.setupFloatingActionButton(o):"sidebar"===e&&editor.setupSidebar(o),editor.setupImageUpload(o),editor.setupIconPicker(o))}else n.removeAttribute(`data-has-${e}`),editor.specialComponents[e].added=!1,editor.specialComponents[e].content=null})),s.querySelectorAll(".icon-container i, .iconContainerClass i").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),showIconPicker(e)}))})),s.querySelectorAll(".delete-btn").forEach((e=>{e.onclick=function(){this.closest(".component-container").remove()}})),s.querySelectorAll(".duplicate-btn").forEach((e=>{e.onclick=function(){const e=this.closest(".component-container");if(e){const t=e.getAttribute("data-component-type");t&&editor.duplicateComponent(e,t)}}}));const r=s.querySelectorAll(".resizeable");r.length&&r.forEach((e=>{resizer.makeResizable(e)})),s.querySelectorAll(".component-container").forEach((e=>{const t=e.querySelector(".component-content");if(t){t.querySelectorAll('[style*="var(--color"]').forEach((t=>{const o=createColorSwatches(t);Array.isArray(o)?o.forEach((t=>{t&&t.children.length>0&&e.insertBefore(t,e.firstChild)})):o&&o.children.length>0&&e.insertBefore(o,e.firstChild)}))}}));const i=function(e){const t=e.querySelector(".data-table-scroll-wrapper");if(!t)return console.warn("Table wrapper not found during restore"),void editor.setupTable(e);setTimeout((()=>{try{const o=t.querySelector(".data-table-main");if(!o)return console.warn("Table element not found in wrapper"),void editor.setupTable(e);const r=editor.setupTable(e);o.querySelectorAll("th.data-table-header-cell").forEach((e=>{const t=e.getAttribute("data-column-type");if(t){const r=e.querySelector(".dt-col-type-selector");if(r){r.value=t;const n=Array.from(e.parentElement.children).indexOf(e),a=o.querySelectorAll("tbody tr");r.value!==t&&a.forEach((e=>{if(e.children.length>n){const o=e.children[n],r=createCell(t);e.replaceChild(r,o)}}))}}})),o.querySelectorAll(".fa-square").forEach((e=>{e.addEventListener("click",(()=>{const t=e.querySelector(".fa-square-check");if(t){const e="none"===t.style.display;t.style.display=e?"block":"none"}}))})),o.querySelectorAll("tr.data-table-row").forEach((e=>{const t=e.querySelector(".row-controls");t&&(e.addEventListener("mouseenter",(()=>{t.style.display="flex"})),e.addEventListener("mouseleave",(()=>{t.style.display="none"})),t.addEventListener("click",(()=>{e.remove()})))})),o.querySelectorAll("th.data-table-header-cell").forEach((e=>{const t=e.querySelector(".data-table-column-controls");if(t){e.addEventListener("mouseenter",(()=>{t.style.display="flex"})),e.addEventListener("mouseleave",(e=>{t.contains(e.relatedTarget)||(t.style.display="none")}));const a=t.querySelector(".dt-col-type-selector");if(a){const i=e.getAttribute("data-column-type")||a.value;e.setAttribute("data-column-type",i),a.addEventListener("change",(()=>{Array.from(e.parentElement.children).indexOf(e);const t=a.value;e.setAttribute("data-column-type",t),r&&"function"==typeof r.updateColumnType&&r.updateColumnType(e,t)}))}const s=t.querySelector(".delete-dt-col-btn");s&&s.addEventListener("click",(()=>{const t=Array.from(e.parentElement.children).indexOf(e);if(r&&"function"==typeof r.deleteColumn)r.deleteColumn(t);else{o.querySelectorAll("tr").forEach((e=>{const o=e.children;o.length>t&&e.removeChild(o[t])}))}}))}o.querySelectorAll("tbody tr").forEach((e=>{let t=e.querySelector(".row-controls");t||(t=document.createElement("i"),t.className="fas fa-trash row-controls",t.setAttribute("title","delete row"),t.style.display="none",e.appendChild(t));const o=t.cloneNode(!0);t.parentNode&&t.parentNode.replaceChild(o,t),t=o,t.addEventListener("click",(()=>{const t=e.closest("tbody");e.remove(),r&&"function"==typeof r.updateAddButtonVisibility&&r.updateAddButtonVisibility(t)})),e.addEventListener("mouseenter",(()=>{e.style.position="relative",t.style.display="flex"})),e.addEventListener("mouseleave",(()=>{e.style.position="initial",t.style.display="none"}))}));const n=e.querySelector(".td-column-resizer");if(n){let c,l,d=!1;function u(t){if(!d)return;const o=t.pageX-c;e.style.width=`${Math.max(60,l+o)}px`}n.addEventListener("mousedown",(t=>{d=!0,c=t.pageX,l=e.offsetWidth;const o=document.createElement("div");o.id="resize-overlay",o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.zIndex="9999",document.body.appendChild(o),document.addEventListener("mousemove",u),document.addEventListener("mouseup",(()=>{d=!1,document.removeEventListener("mousemove",u),o.parentNode&&o.parentNode.removeChild(o)}),{once:!0}),t.preventDefault()}))}}))}catch(e){console.error("Error in enhanced table setup:",e)}}),100)};editor.setupImageUpload(s),editor.setupIconPicker(s),editor.initializeSortable(s),s.querySelectorAll(".component-container").forEach((e=>{const t=e.getAttribute("data-component-type"),o=e.querySelector(".component-content");if(t&&o)switch(t&&editor.setupVariantControls(e,o,t),t){case"adjustableSpace":const t=o.querySelector(".blankSpace");t&&editor.copyAdjustableSpaceState(t,t);break;case"heading":const r=o.querySelector(".heading-wrapper");if(!r)break;const n=r.querySelector(".heading-controls"),a=r.querySelector(".level-indicator"),s=r.querySelector(".heading-increment-btn");if(!n||!a||!s)break;const c=r.querySelector("h1, h2, h3, h4, h5, h6");c&&(r.dataset.headingLevel=c.tagName.toLowerCase()),r.addEventListener("mouseenter",(()=>{n.style.display="flex",n.style.opacity="1",a.style.opacity="1",s.style.opacity="1"})),r.addEventListener("mouseleave",(()=>{n.style.opacity="0",a.style.opacity="0",s.style.opacity="0",setTimeout((()=>{n.style.display="none"}),200)})),s.addEventListener("click",(()=>{const e=r.dataset.headingLevel||"h1",t=["h1","h2","h3","h4","h5","h6"].indexOf(e);editor.updateHeadingLevel(r,t+1)}));break;case"icon":const l=o.querySelector(".iconContainerClass");editor.copyIconState(l,l);const d=createAlignmentControls(l);o.iconAlignment=d;break;case"avatar":const u=o.querySelector(".align-content");if(u){createAlignmentControls(u);const e=u.getAttribute("data-alignment");e&&(u.style.justifyContent=e)}break;case"blankCard":editor.setupBlankCard(e);break;case"bulletedList":editor.setupBulletedList(o);break;case"columns":editor.setupColumns(o.querySelector(".columns-wrapper"));break;case"notificationBanner":editor.setupNotificationBanner(o);break;case"progressTracker":editor.setupProgressTracker(e);break;case"pagination":e.querySelectorAll(".color-swatch-container").forEach((e=>e.remove())),editor.setupPagination(e);break;case"divider":editor.copyDividerState(o);break;case"chipGroup":editor.setupChipGroup(e),createGroupColorSwatch(e);break;case"tabs":editor.setupTabs(e);break;case"table":i(o);break;case"accordion":const p=o.querySelector(".accordion-content");editor.initializeSortable(p),editor.setupAccordionContent(p);break;case"hzDivider":editor.setupDividerState(o);break;case"colorBlock":const h=o.querySelector(".colorBlock-inner");editor.initializeSortable(h);break;case"checkbox":const m=o.querySelector(".checkbox-square-icon"),g=o.querySelector(".checkbox-check-icon");m.addEventListener("click",(()=>{g.classList.toggle("checked")}));const y=o.querySelector("span");editor.makeTextEditable(y);break;case"radio":const f=o.querySelector(".custom-radio"),v=f.querySelector("span");f.addEventListener("click",(()=>{document.querySelectorAll(".custom-radio").forEach((e=>{e.querySelector("span").style.display="none",e.style.borderColor="#e0e0e0"})),v.style.display="block",f.style.borderColor="var(--color-primary)"}));const b=o.querySelector('span:not([style*="border-radius"])');editor.makeTextEditable(b);break;case"toggleSwitch":const w=o.querySelector(".toggle-switch"),S=w.querySelector(".toggle-slider"),C=w.querySelector(".toggle-thumb");let E=!1;const k=()=>{E=!E,E?(S.style.backgroundColor="var(--color-primary)",C.style.left="30px"):(S.style.backgroundColor="var(--neutral-gray)",C.style.left="4px")};w.addEventListener("click",k);break;case"slider":const x=o.querySelector(".custom-range-slider"),A=o.querySelector(".range-value");x.addEventListener("input",(()=>{A.textContent=x.value}));break;case"textarea":editor.setupResize(o);break;case"imgGallery":setupImageGallery(o);break;case"progressBar":editor.setupProgressBar(o);break;case"featureComparisonCard":editor.setupFeatureComparisonCard(e);break;case"graph":createGraphColorSwatch(e);break;case"datePicker":const j=document.querySelector(".date-picker-wrapper");if(j){const e=j.querySelector("span"),t=j.querySelector(".date-picker-icon"),o=j.querySelector(".date-picker-calendar-con");editor.setupDatePicker(j,e,t,o)}break;case"dropdown":editor.setupDropdown(e)}}))}requestAnimationFrame((()=>{s.querySelectorAll('[style*="background-color"]').forEach((e=>{window.TextContrastAdjuster&&window.TextContrastAdjuster.updateElementContrast(e)}));s.querySelectorAll('[style*="var(--"]').forEach((e=>{window.TextContrastAdjuster&&window.TextContrastAdjuster.updateElementContrast(e)}))}))}this.currentProject={id:e,name:o.project_name},new TextAlignmentController(".canvas-content"),hideModal("projects-modal"),this.showNotification("Project loaded successfully"),setTimeout((()=>{this.setupAutoSave()}),4e3)}catch(e){console.error("Error loading canvases:",e),this.showNotification("Error loading canvases","error")}}setCurrentProject(e){this.currentProject=e}async checkProjectLimit(){try{const e=this.db.collection("project"),t=await e.where("owner","==",this.db.doc(`users/${this.currentUser.uid}`)).get().then((e=>e.size)),o=await this.db.collection("users").doc(this.currentUser.uid).get(),r=o.exists&&!0===o.data().pro_account;return t>=2&&!r?void this.showSubscriptionModal("Upgrade to Create Unlimited Projects","You've reached the limit for free projects."):void this.handleNewProject()}catch(e){console.error("Error checking project limit:",e)}}async loadUserProjects(){try{if(!this.currentUser?.uid)throw new Error("No authenticated user");const e=firebase.firestore().doc(`users/${this.currentUser.uid}`),t=firebase.firestore().collection("project").where("owner","==",e).orderBy("last_edited","desc"),o=(await t.get()).docs;this.displayProjectsList(o)}catch(e){console.error("Error fetching user projects:",e.message)}}async displayProjectsList(e){const t=document.querySelector("#projects-container");if(t){if(t.innerHTML="",0===e.length){const e=document.createElement("div");return e.className="no-projects-message",e.innerHTML='\n                <i class="fa-regular fa-folder"></i> &nbsp; <i class="fa-solid fa-exclamation"></i>\n                <h2>No Projects Found</h2>\n                <p>Click "New Project" to get started!</p>\n            ',void t.appendChild(e)}for(const o of e){const e=o.data(),r=document.createElement("div");r.className="project-item";const n=await firebase.firestore().collection("project").doc(o.id).collection("saved_screens").get().then((e=>e.size)).catch((e=>(console.error("Error getting screens count:",e),0)));let a="Open Sans";e.fonts&&e.fonts.primaryFont&&(a=e.fonts.primaryFont,this.ensureFontLoaded(a)),r.innerHTML=`\n                <div class="project-info" onclick="projectManager.loadProject('${o.id}')">\n                    <div class="project-image-container" style="width: 42px; height: 42px; background-color: var(--neutral-gray); cursor: pointer; border-radius: 50%; overflow: hidden; position: relative;">\n                        <i class="fas fa-image" style="color: var(--placeholder-color); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>\n                        <div class="project-image" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; background-image: url(${e.img_hero_proj}); background-size: cover; background-position: center; background-repeat: no-repeat;"></div>\n                    </div>\n                    <div>\n                        <h3 style="font-family: '${a}', sans-serif;">${e.project_name}</h3>\n                        <span>Last edited: ${e.last_edited?.toDate().toLocaleString()||"N/A"}</span>\n                    </div>\n                </div>\n                <div class="project-actions">\n                    <button onclick="projectManager.loadProject('${o.id}')" class="open-btn">\n                        <i class="fas fa-folder-open"></i> Open\n                    </button>\n                    <br>\n                    <span style="color: var(--placeholder-color); margin-right: 8px; font-size: 12px;">${n} screens</span>\n                </div>\n            `,t.appendChild(r)}}else console.warn("Projects container not found in DOM")}ensureFontLoaded(e){if(!e||"string"!=typeof e)return;const t=e.trim();if(!document.fonts.check(`12px "${t}"`)){!(window.fonts&&Array.isArray(window.fonts)&&window.fonts.some((e=>e.split(":")[0].toLowerCase()===t.toLowerCase())))&&window.fonts&&window.fonts.unshift(`${t}:,400,700: SansFilter :Google Fonts`);const e=t.replace(/\s+/g,"+");if(!document.querySelector(`link[href*="${e}"]`)){const o=document.createElement("link");o.href=`https://fonts.googleapis.com/css?family=${e}`,o.rel="stylesheet",document.head.appendChild(o),console.log(`Added font stylesheet: ${t}`)}}}showNotification(e,t="success"){const o=document.createElement("div");o.className=`notification ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.remove()}),3800)}saveFontSelection(e,t){if(this.currentProject?.id&&!this.isSavingFonts)try{this.isSavingFonts=!0;const o=this.getCurrentFonts(),r=JSON.parse(localStorage.getItem(`projectFonts_${this.currentProject.id}`))||{};if(r[e]===t)return void(this.isSavingFonts=!1);r[e]=t,localStorage.setItem(`projectFonts_${this.currentProject.id}`,JSON.stringify(r)),this.pendingUpdates={...this.pendingUpdates,fonts:{...o,[e]:t,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()}},this.pendingWriteTimer||(this.pendingWriteTimer=setTimeout((()=>{this.flushPendingUpdates()}),8e3)),this.contentChanged=!0}catch(e){console.error("Error saving font selection:",e)}finally{this.isSavingFonts=!1}}getCurrentFonts(){return{primaryFont:document.documentElement.style.getPropertyValue("--primary-font").trim()||"",secondaryFont:document.documentElement.style.getPropertyValue("--secondary-font").trim()||""}}flushPendingUpdates(){if(this.pendingUpdates&&this.currentProject?.id)try{this.db.collection("project").doc(this.currentProject.id).update(this.pendingUpdates),console.log("Updates saved successfully (colors and fonts)"),this.pendingUpdates={},this.pendingWriteTimer=null,this.isSavingColors=!1,this.isSavingFonts=!1}catch(e){console.error("Error saving updates:",e),this.isSavingColors=!1,this.isSavingFonts=!1}else this.pendingWriteTimer=null}async loadProjectFonts(e){try{const t=await this.db.collection("project").doc(e).get();if(!t.exists)return void console.log("Project not found when loading fonts");const o=t.data(),r=o.fonts||{},n={primaryFont:"Open Sans",secondaryFont:"Roboto"},a={primaryFont:r.primaryFont||n.primaryFont,secondaryFont:r.secondaryFont||n.secondaryFont};document.documentElement.style.setProperty("--primary-font",a.primaryFont),document.documentElement.style.setProperty("--secondary-font",a.secondaryFont),a.primaryFont&&this.ensureFontInArray(a.primaryFont),a.secondaryFont&&this.ensureFontInArray(a.secondaryFont),this.updateFontPickers(a),localStorage.setItem(`projectFonts_${e}`,JSON.stringify(a)),o.fonts||this.currentProject?.id!==e||(this.saveFontSelection("primaryFont",a.primaryFont),this.saveFontSelection("secondaryFont",a.secondaryFont))}catch(e){console.error("Error loading project fonts:",e)}}refreshFontDropdowns(){if("undefined"==typeof $)return void console.warn("jQuery not available for font refresh");const e=$(".font-select");e.length?e.each((function(){const e=$(this).find(".fs-results");if(!e.length)return;const t=e.find("li.active"),o=t.length?t.data("value"):null,r=window.fonts.map((e=>{const t=e.split(":"),o=t[0],r=t[1]||"";return`<li class="${t[2]||""}" data-value="${o}:400${r}" \n                style="font-family: ${o}; font-weight:400,${r}">\n                ${o}<br><smAllFilter style="font-size: 13px;">${t[3]||""}</smAllFilter></li>`})).join("");e.html(r),o&&e.find(`li[data-value^="${o.split(":")[0]}:"]`).addClass("active"),e.find("li").click((function(){const e=$(this).data("value"),t=$(this).closest(".font-select");t.prev("select, input").val(e).change();const o=e.split(":")[0];t.find(".Fselectbtn span").text(o).css("font-family",o),t.removeClass("font-select-active"),t.find(".fs-drop").hide()}))})):console.warn("No font selectors found")}ensureFontInArray(e){if(!e||"string"!=typeof e)return!1;const t=e.trim();if(!window.fonts.some((e=>e.split(":")[0].toLowerCase()===t.toLowerCase()))){const e=`${t}:,400,700: SansFilter :Google Fonts`;window.fonts.unshift(e);const o=t.replace(/\s+/g,"+"),r=document.createElement("link");return r.href=`https://fonts.googleapis.com/css?family=${o}`,r.rel="stylesheet",document.head.appendChild(r),this.refreshFontDropdowns(),!0}return!1}updateFontPickers(e){try{if(e.primaryFont&&this.ensureFontInArray(e.primaryFont),e.secondaryFont&&this.ensureFontInArray(e.secondaryFont),"undefined"==typeof $||!$("#fontPicker1").length||!$("#fontPicker2").length)return void console.warn("Font pickers not found or jQuery not available");setTimeout((()=>{e.primaryFont&&$("#fontPicker1").trigger("setFont",e.primaryFont).trigger("change"),e.secondaryFont&&$("#fontPicker2").trigger("setFont",e.secondaryFont).trigger("change")}),500)}catch(e){console.error("Error updating font pickers:",e)}}async handleSignOut(){try{this.currentProject=null,this.contentChanged=!1,this.clearAutoSave(),localStorage.removeItem("lastActiveProject"),Object.keys(localStorage).forEach((e=>{e.startsWith("projectColors_")&&localStorage.removeItem(e)})),document.documentElement.style.setProperty("--primary-font","Open Sans"),document.documentElement.style.setProperty("--secondary-font","Roboto"),"undefined"!=typeof $&&setTimeout((()=>{$("#fontPicker1").length&&$("#fontPicker1").val("Open Sans:regular").trigger("setFont","Open Sans"),$("#fontPicker2").length&&$("#fontPicker2").val("Roboto:regular").trigger("setFont","Roboto")}),300);const e=document.querySelector("#project-title h3");e&&(e.textContent="",e.style.display="none");document.querySelectorAll(".canvas-wrapper").forEach((e=>e.remove())),editor&&(editor.resetCanvasCount(),setTimeout((()=>{editor.createNewCanvas();const e=document.querySelector(".canvas-wrapper");if(e){const t=e.querySelector(".canvas-content");if(t){editor.setupImageUpload(t),editor.setupIconPicker(t),editor.initializeSortable(t);const o=e.querySelector(".canvas");o&&(editor.state.selectedCanvases.clear(),editor.state.selectedCanvases.add(o),o.classList.add("selected"),o.addEventListener("click",(e=>editor.handleCanvasSelection(e))))}}}),50));const t=document.querySelector(".save-canvas-btn");t&&(t.style.display="none");const o=document.querySelector(".canvas-timestamp");o&&(o.textContent=""),window.colorPicker&&(colorPicker.colors[0].hexString="#3498db",colorPicker.colors[1].hexString="#5f615d",colorPicker.colors[2].hexString="#fbd513"),document.documentElement.style.setProperty("--color-primary","#3498db"),document.documentElement.style.setProperty("--primary-color","#3498db"),document.documentElement.style.setProperty("--color-secondary","#5f615d"),document.documentElement.style.setProperty("--color-accent","#fbd513"),this.pendingUpdates={},this.pendingWriteTimer&&(clearTimeout(this.pendingWriteTimer),this.pendingWriteTimer=null),document.querySelector(".user-profile-section").style.display="none",document.querySelector(".login-button").style.display="flex",document.querySelector("#open-projects-btn").style.display="none";document.querySelectorAll(".modal").forEach((e=>{"flex"===e.style.display&&(e.style.display="none")})),this.showNotification("Signed out successfully")}catch(e){console.error("Error during sign out cleanup:",e),this.showNotification("Error during sign out","error")}}}const projectManager=new ProjectManager;function showModal(e){document.getElementById(e).style.display="flex"}function hideModal(e){document.getElementById(e).style.display="none"}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("open-projects-btn");e&&e.addEventListener("click",(()=>showModal("projects-modal"))),document.querySelectorAll(".close-modal").forEach((e=>{e.addEventListener("click",(()=>{const t=e.closest(".modal");t&&hideModal(t.id)}))})),document.querySelectorAll(".modal").forEach((e=>{e.addEventListener("click",(t=>{t.target===e&&hideModal(e.id)}))}))})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(document.querySelector(".modal-overlay").style.display="none",document.querySelectorAll(".modal").forEach((e=>{"flex"===e.style.display&&hideModal(e.id)})))})),firebase.auth().onAuthStateChanged((async e=>{if(e)try{(await firebase.firestore().collection("users").doc(e.uid).get()).exists||await firebase.firestore().collection("users").doc(e.uid).set({display_name:e.displayName||e.email,photo_url:e.photoURL||"https://firebasestorage.googleapis.com/v0/b/experience-builder-m-v-wxacv7.appspot.com/o/avatar-placeholder.png?alt=media&token=6e0896e6-0285-46d9-b251-6b8ee8f690f4",email:e.email,created_time:e.createdTime||firebase.firestore.FieldValue.serverTimestamp(),last_active_time:firebase.firestore.FieldValue.serverTimestamp(),logged_in:!0}),document.querySelector(".user-profile-section").innerHTML=`\n                <div class="user-info">\n                    <img src="${e.photoURL||"https://firebasestorage.googleapis.com/v0/b/experience-builder-m-v-wxacv7.appspot.com/o/avatar-placeholder.png?alt=media&token=6e0896e6-0285-46d9-b251-6b8ee8f690f4"}" \n                         alt="Profile" \n                         class="profile-photo">\n                    <span>${e.displayName||e.email}</span>\n                </div>\n                <button onclick="projectManager.handleSignOut().then(() => firebase.auth().signOut())" class="logout-btn">\n                    <i class="fas fa-sign-out-alt"></i>\n                </button>\n            `,document.querySelector(".user-profile-section").style.display="flex",document.querySelector("#open-projects-btn").style.display="block",document.querySelector(".login-button").style.display="none";const t=document.querySelector("#auth-modal");t&&(t.style.display="none")}catch(e){console.error("Error handling auth state:",e)}})),"localhost"===location.hostname&&firebase.functions().useEmulator("localhost",5001);class StripeClientHandler{constructor(){if("undefined"==typeof Stripe)throw console.error("Stripe.js is not loaded"),new Error("Stripe.js is not loaded");this.STRIPE_PUBLISHABLE_KEY="pk_live_51Img78K5ZALgdbfFCDxjFQ8p0ZdoaozqL4qKqkJYRir3pGzcrlRBGvdqoq8ERRLVhhK7Y78q3PDpLhsH7pNss30U00RkPCgolE",this.stripe=Stripe(this.STRIPE_PUBLISHABLE_KEY),this.PRICE_IDS={monthly:"price_1PnTWAK5ZALgdbfFDXytlpJ6",yearly:"price_1PnTdKK5ZALgdbfFhyRw7qma"},this.API_BASE_URL="https://us-central1-experience-builder-m-v-wxacv7.cloudfunctions.net/api",this.maxRetries=2}async handleSubscription(e,t,o,r,n){let a=0;const s=async()=>{try{if(!e)throw new Error("User not authenticated");console.log("Starting subscription process:",{userEmail:t,plan:o,successUrl:r,cancelUrl:n});const s=await e.getIdToken(!0),i=await firebase.firestore().collection("users").doc(e.uid).get();let c=i.exists&&i.data()?.stripe_customer_key;if(c)console.log("Using existing customer ID:",c);else{console.log("No customer ID found, creating a new Stripe customer");try{const e=await fetch(`${this.API_BASE_URL}/create-customer`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({email:t})});if(!e.ok){const t=await e.json();throw new Error(t.error||"Failed to create customer")}const o=await e.json();if(!o||!o.customerId)throw console.error("Failed to create customer:",o),new Error("Failed to create Stripe customer");c=o.customerId,console.log("Created new customer:",c)}catch(e){throw console.error("Error creating Stripe customer:",e),new Error(`Customer creation failed: ${e.message}`)}}const l=this.PRICE_IDS[o];if(!l)throw new Error(`Invalid plan selected: ${o}`);console.log("Creating checkout session with:",{customerId:c,priceId:l,successUrl:r,cancelUrl:n});try{const e={customerId:c,priceId:l,successUrl:r,cancelUrl:n,domain:window.location.origin};console.log("Sending payload to create-checkout endpoint:",e);const t=await fetch(`${this.API_BASE_URL}/create-checkout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(e)});if(!t.ok){const e=await t.json();throw new Error(e.error||"Failed to create checkout session")}const o=await t.json();if(console.log("Checkout session created:",o),!o||!o.url)throw console.error("Invalid session result:",o),new Error("Failed to create checkout session");return o.url}catch(e){console.error("Checkout session creation failed:",e);if((e.message?.includes("network")||e.message?.includes("timeout")||e.message?.includes("internal"))&&a<this.maxRetries)throw{isRetryable:!0,originalError:e};throw new Error(`Checkout session creation failed: ${e.message}`)}}catch(e){if(e.isRetryable)throw e;throw e}};for(;;)try{return await s()}catch(e){if(e.isRetryable&&a<this.maxRetries){const e=1e3*Math.pow(2,a);console.log(`Retrying Stripe operation in ${e/1e3}s... (Attempt ${a+1}/${this.maxRetries})`),await new Promise((t=>setTimeout(t,e))),a++;continue}const t=e.originalError||e;throw console.error("Subscription process failed:",t),t}}async handleSubscriptionLegacy(e,t,o,r,n){let a=0;const s=async()=>{try{if(!e)throw new Error("User not authenticated");console.log("Starting subscription process (legacy):",{userEmail:t,plan:o,successUrl:r,cancelUrl:n}),await e.getIdToken(!0);const s=await firebase.firestore().collection("users").doc(e.uid).get();let i=s.exists&&s.data()?.stripe_customer_key;if(i)console.log("Using existing customer ID:",i);else{console.log("No customer ID found, creating a new Stripe customer");try{const e=firebase.functions().httpsCallable("createStripeCustomer"),o=await e({email:t});if(!o.data||!o.data.customerId)throw console.error("Failed to create customer:",o),new Error("Failed to create Stripe customer");i=o.data.customerId,console.log("Created new customer:",i)}catch(e){throw console.error("Error creating Stripe customer:",e),new Error(`Customer creation failed: ${e.message}`)}}const c=this.PRICE_IDS[o];if(!c)throw new Error(`Invalid plan selected: ${o}`);console.log("Creating checkout session with:",{customerId:i,priceId:c,successUrl:r,cancelUrl:n});try{const e=firebase.functions().httpsCallable("createCheckoutSession"),t={customerId:i,priceId:c,successUrl:r,cancelUrl:n,domain:window.location.origin};console.log("Sending payload to createCheckoutSession:",t);const o=await e(t);if(console.log("Checkout session created:",o),!o.data||!o.data.url)throw console.error("Invalid session result:",o),new Error("Failed to create checkout session");return o.data.url}catch(e){console.error("Callable checkout session creation failed:",e);if(("functions/internal"===e.code||"functions/unavailable"===e.code||e.message?.includes("network")||e.message?.includes("timeout"))&&a<this.maxRetries)throw{isRetryable:!0,originalError:e};throw new Error(`Checkout session creation failed: ${e.message}`)}}catch(e){if(e.isRetryable)throw e;throw e}};for(;;)try{return await s()}catch(e){if(e.isRetryable&&a<this.maxRetries){const e=1e3*Math.pow(2,a);console.log(`Retrying Stripe operation in ${e/1e3}s... (Attempt ${a+1}/${this.maxRetries})`),await new Promise((t=>setTimeout(t,e))),a++;continue}const t=e.originalError||e;throw console.error("Subscription process failed:",t),t}}}function showConfirmDialog(e,t={}){return document.getElementById("projects-modal")&&hideModal("projects-modal"),new Promise((o=>{const r=document.createElement("div");r.className="confirmation-dialog",r.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999991;\n        ";const n=document.createElement("div");n.style.cssText="\n            background: var(--input-bg-color);\n            padding: 24px;\n            border-radius: 8px;\n            width: 90%;\n            max-width: 400px;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n            animation: fadeIn 0.2s ease-out;\n        ";const a=document.createElement("style");a.textContent="\n            @keyframes fadeIn {\n                from { opacity: 0; transform: translateY(-20px); }\n                to { opacity: 1; transform: translateY(0); }\n            }\n        ",document.head.appendChild(a),n.innerHTML=`\n            <h3 style="margin-top: 0; color: var(--basic-txt-color);">${t.heading||"Confirm Action"}</h3>\n            <p style="color: var(--basic-txt-color); margin-bottom: 24px;">${e}</p>\n            <div style="display: flex; justify-content: flex-end; gap: 12px;">\n                <button class="cancel-btn" style="\n                    padding: 8px 16px;\n                    border: none;\n                    border-radius: 4px;\n                    background: var(--neutral-gray);\n                    color: var(--basic-txt-color);\n                    cursor: pointer;\n                ">${t.cancelText||"Cancel"}</button>\n                <button class="confirm-btn" style="\n                    padding: 8px 16px;\n                    border: none;\n                    border-radius: 4px;\n                    background: var(--color-primary);\n                    color: var(--basic-txt-color);\n                    cursor: pointer;\n                ">${t.confirmText||"Confirm"}</button>\n            </div>\n        `,r.appendChild(n),document.body.appendChild(r),n.querySelector(".confirm-btn").addEventListener("click",(()=>{r.remove(),o(!0)})),n.querySelector(".cancel-btn").addEventListener("click",(()=>{r.remove(),o(!1)})),document.addEventListener("keydown",(function e(t){"Escape"===t.key&&(document.removeEventListener("keydown",e),r.remove(),o(!1))})),r.addEventListener("click",(e=>{e.target===r&&(r.remove(),o(!1))}))}))}function showPromptDialog(e,t="",o={}){return new Promise((r=>{const n=document.createElement("div");n.className="prompt-dialog",n.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            z-index: 999999;\n        ";const a=document.createElement("div");a.style.cssText="\n            background: var(--input-bg-color);\n            padding: 24px;\n            border-radius: 8px;\n            width: 90%;\n            max-width: 400px;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n            animation: fadeIn 0.2s ease-out;\n        ",a.innerHTML=`\n            <h3 style="margin-top: 0; color: var(--basic-txt-color);">${o.heading||"Enter Value"}</h3>\n            <p style="color: var(--basic-txt-color); margin-bottom: 16px;">${e}</p>\n            <input type="text" value="${t}" style="\n                width: 100%;\n                padding: 8px;\n                margin-bottom: 24px;\n                border: 1px solid var(--neutral-gray);\n                border-radius: 4px;\n                background: var(--input-bg-color);\n                color: var(--basic-txt-color);\n            ">\n            <div style="display: flex; justify-content: flex-end; gap: 12px;">\n                <button class="cancel-btn" style="\n                    padding: 8px 16px;\n                    border: none;\n                    border-radius: 4px;\n                    background: var(--neutral-gray);\n                    color: var(--basic-txt-color);\n                    cursor: pointer;\n                ">${o.cancelText||"Cancel"}</button>\n                <button class="confirm-btn" style="\n                    padding: 8px 16px;\n                    border: none;\n                    border-radius: 4px;\n                    background: var(--color-primary);\n                    color: var(--basic-txt-color);\n                    cursor: pointer;\n                ">${o.confirmText||"OK"}</button>\n            </div>\n        `,n.appendChild(a),document.body.appendChild(n);const s=a.querySelector("input");s.focus(),s.select(),a.querySelector(".confirm-btn").addEventListener("click",(()=>{const e=s.value.trim();n.remove(),r(e)})),a.querySelector(".cancel-btn").addEventListener("click",(()=>{n.remove(),r(null)})),s.addEventListener("keypress",(e=>{if("Enter"===e.key){const e=s.value.trim();n.remove(),r(e)}})),document.addEventListener("keydown",(function e(t){"Escape"===t.key&&(document.removeEventListener("keydown",e),n.remove(),r(null))})),n.addEventListener("click",(e=>{e.target===n&&(n.remove(),r(null))}))}))}document.addEventListener("DOMContentLoaded",(()=>{projectManager&&projectManager.checkSubscriptionStatus()}));class SaveButtonHandler{constructor(e,t=5e3){this.button=document.querySelector(e),this.cooldownTime=t,this.isEnabled=!0,this.timeoutId=null,this.remainingTime=0,this.updateInterval=null,this.button&&this.setupButton()}setupButton(){if(this.button.addEventListener("click",(()=>this.handleSave())),!this.button.querySelector(".cooldown-tooltip")){const e=document.createElement("span");e.className="cooldown-tooltip",e.style.display="none",this.button.appendChild(e)}}async handleSave(){if(this.isEnabled)if(projectManager.hasUnsavedChanges()){try{this.disableButton(),await projectManager.saveCanvases(),this.startCooldown(),projectManager.showNotification("Changes saved successfully!","success")}catch(e){console.error("Save failed:",e),this.enableButton(),projectManager.showNotification("Failed to save changes","error")}projectManager.resetChangeTracking()}else projectManager.showNotification("No changes to save")}disableButton(){this.isEnabled=!1,this.button.classList.add("disabled")}enableButton(){this.isEnabled=!0,this.button.classList.remove("disabled");const e=this.button.querySelector(".cooldown-tooltip");e&&(e.style.display="none")}startCooldown(){this.remainingTime=this.cooldownTime,this.updateInterval&&clearInterval(this.updateInterval),this.updateInterval=setInterval((()=>{this.remainingTime-=1e3,this.updateTooltip(),this.remainingTime<=0&&(clearInterval(this.updateInterval),this.enableButton())}),1e3),this.updateTooltip(),this.timeoutId=setTimeout((()=>{this.enableButton()}),this.cooldownTime)}updateTooltip(){const e=this.button.querySelector(".cooldown-tooltip");if(e){const t=Math.ceil(this.remainingTime/1e3);e.textContent=`${t}s`,e.style.display="block"}}}const saveHandler=new SaveButtonHandler(".save-canvas-btn",3e4);