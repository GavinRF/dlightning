const firebaseConfig={apiKey:"AIzaSyB5KJ3Q8psMbG0wc6Dh9fF2-Wq7pt7sOa0",authDomain:"experience-builder-m-v-wxacv7.firebaseapp.com",projectId:"experience-builder-m-v-wxacv7",storageBucket:"experience-builder-m-v-wxacv7.appspot.com",messagingSenderId:"940965852397",appId:"1:940965852397:web:06f19e756e7db4b7d748e4"};firebase.initializeApp(firebaseConfig);const db=firebase.firestore(),auth=firebase.auth(),startFirebaseUI=()=>{const e=new firebaseui.auth.AuthUI(firebase.auth()),t={signInOptions:[{provider:firebase.auth.GoogleAuthProvider.PROVIDER_ID,scopes:["profile","email"]},firebase.auth.EmailAuthProvider.PROVIDER_ID],signInFlow:"popup",callbacks:{signInSuccessWithAuthResult:e=>(console.log("Sign in success:",e),!1),signInFailure:e=>{console.error("Sign in failed:",e)}}};e.start("#firebaseui-auth-container",t)};function showAuthModal(){if(!document.getElementById("auth-modal")){const e='\n            <div id="auth-modal" class="modal">\n                <div class="modal-content">\n                    <button class="close-modal">&times;</button>\n                    <h2>Sign in to Save Projects</h2>\n                    <div id="firebaseui-auth-container"></div>\n                </div>\n            </div>\n        ';document.body.insertAdjacentHTML("beforeend",e),startFirebaseUI(),document.querySelector("#auth-modal .close-modal").addEventListener("click",hideAuthModal)}document.getElementById("auth-modal").style.display="flex"}function hideAuthModal(){const e=document.getElementById("auth-modal");e&&(e.style.display="none",e.remove())}document.addEventListener("keydown",(e=>{"Escape"===e.key&&hideAuthModal()}));const initAuth=()=>{document.createElement("div").id="firebaseui-auth-container";const e=new firebaseui.auth.AuthUI(firebase.auth()),t={signInOptions:[firebase.auth.GoogleAuthProvider.PROVIDER_ID,firebase.auth.EmailAuthProvider.PROVIDER_ID],callbacks:{signInSuccessWithAuthResult:e=>(initUserData(e.user),!1)}};e.start("#firebaseui-auth-container",t)};class ImageManager{constructor(){this.imageCache=new Map,this.processedImages=new Set,this.processing=new Map,this.maxCacheSize=50,this.batchSize=5}generateImageId(){return`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async processImage(e){try{if(this.imageCache.has(e))return this.imageCache.get(e);if(this.processing.has(e))return await this.processing.get(e);const t=(async()=>{try{const t=await this.hashImage(e);if(this.processedImages.has(t))return this.imageCache.get(t);let o;if(o=this.getBase64Size(e)>500?await this.compressImage(e):e,this.imageCache.size>=this.maxCacheSize){const e=this.imageCache.keys().next().value;this.imageCache.delete(e),this.processedImages.delete(e)}return this.processedImages.add(t),this.imageCache.set(e,o),o}finally{this.processing.delete(e)}})();return this.processing.set(e,t),await t}catch(t){return console.error("Error processing image:",t),e}}async hashImage(e){const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map((e=>e.toString(16).padStart(2,"0"))).join("")}getBase64Size(e){return 3*(e.length-(e.indexOf(",")+1))/4/1024}async batchProcessImages(e,t=null){const o=t||this.batchSize,r=[];for(let t=0;t<e.length;t+=o){const a=e.slice(t,t+o);try{const e=await Promise.all(a.map((e=>this.processImage(e))));r.push(...e)}catch(e){console.error(`Error processing batch ${t/o}:`,e),r.push(...a)}t+o<e.length&&await new Promise((e=>setTimeout(e,100)))}return r}async compressImage(e){try{return new Promise(((t,o)=>{const r=new Image;r.onload=async()=>{try{let e=await this.attemptCompression(r,.8),o=this.getBase64Size(e);if(o>700){const t=[{maxDimension:1280,quality:.7},{maxDimension:1024,quality:.6},{maxDimension:800,quality:.5},{maxDimension:640,quality:.4}];for(const a of t)if(e=await this.attemptCompression(r,a.quality,a.maxDimension),o=this.getBase64Size(e),o<=700)break;o>700&&(e=await this.attemptCompression(r,.3,480))}t(e)}catch(e){console.error("Error setting up canvas:",e),o(e)}},r.onerror=e=>{console.error("Error loading image:",e),o(e)},r.src=e})).catch((t=>(console.error("Image compression failed:",t),e)))}catch(t){return console.error("Compression function failed:",t),e}}async attemptCompression(e,t,o=1920){const r=document.createElement("canvas"),a=r.getContext("2d");let{width:n,height:s}=this.calculateDimensions(e.width,e.height,o);return r.width=n,r.height=s,a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(e,0,0,n,s),r.toDataURL("image/jpeg",t)}calculateDimensions(e,t,o=1920){if(e<=o&&t<=o)return{width:e,height:t};const r=e/t;return e>t?t=(e=o)/r:e=(t=o)*r,{width:Math.floor(e),height:Math.floor(t)}}}const imageManager=new ImageManager;class ProjectManager{constructor(){this.currentUser=null,this.currentProject=null,this.db=firebase.firestore(),this.autoSaveInterval=null,this.contentChanged=!1,this.setupChangeDetection(),this.initAuthListener(),this.initEventListeners()}initEventListeners(){document.getElementById("new-project-btn").addEventListener("click",(()=>{this.checkProjectLimit()}))}async handleNewProject(){if(this.currentUser)try{const e=prompt("Enter project name:","Untitled Project");if(!e)return;await this.createNewProject(e)}catch(e){console.error("Error handling new project:",e),this.showNotification("Error creating new project","error")}else showAuthModal()}async createNewProject(e){try{const t=firebase.firestore.FieldValue.serverTimestamp(),o=await this.db.collection("project").add({project_name:e,owner:this.db.doc(`users/${this.currentUser.uid}`),description:"",complete_percent:0,img_hero_proj:"https://firebasestorage.googleapis.com/v0/b/experience-builder-m-v-wxacv7.appspot.com/o/noisy-gradients-lighter-sm.png?alt=media&token=947bbdf8-1752-4be0-b6e8-b15cf1c23556",last_edited:t,pinned_project:!1,private:!1,start_date:t,user_role:["-"],users_assigned:[this.db.doc(`users/${this.currentUser.uid}`)],time_created:t,canvases:[{index:0,content:"",hasTopNav:!1,hasBottomNav:!1}]});this.currentProject={id:o.id,name:e};const r=document.querySelector("#project-title h3");if(r&&(r.textContent=e,r.style.display="block"),document.querySelectorAll(".canvas-wrapper").forEach((e=>e.remove())),!editor)return console.error("Editor not found"),void this.showNotification("Error initializing canvas","error");{editor.createNewCanvas();const e=document.querySelector(".canvas");e.classList.add("selected"),e&&(editor.state.selectedCanvases.add(e),e.addEventListener("click",(e=>editor.handleCanvasSelection(e))))}this.setupAutoSave(),hideModal("projects-modal"),this.showNotification("Project created successfully!"),await this.loadUserProjects()}catch(e){console.error("Error creating project:",e),this.showNotification("Error creating project","error")}}showSubscriptionModal(){const e=document.createElement("div");e.className="modal subscription-modal",e.innerHTML='\n            <div class="modal-content">\n                <h2>Upgrade to Create Unlimited Projects</h2>\n                <p>You\'ve reached the limit for free projects.</p>\n                <div class="modal-buttons">\n                    <button onclick="window.location.href=\'/upgrade\'">Upgrade Now</button>\n                    <button onclick="this.closest(\'.modal\').remove()">Cancel</button>\n                </div>\n            </div>\n        ',document.body.appendChild(e),e.style.display="flex"}async getUserProjectCount(){return(await this.db.collection("projects").where("owner","==",this.currentUser.uid).get()).size}initAuthListener(){firebase.auth().onAuthStateChanged((async e=>{if(this.currentUser=e,e)this.loadUserProjects();else{this.clearAutoSave();const e=document.querySelector("#project-title h3");e&&(e.style.display="none")}}))}async saveCanvases(){if(firebase.auth().currentUser&&this.currentProject?.id&&this.contentChanged)try{const e=document.querySelectorAll(".canvas-wrapper"),t=(new Date).toLocaleString();this.contentChanged=!1;const o=document.querySelector(".canvas-timestamp");o&&(o.textContent=`Last saved: ${t}`);const r=await Promise.all(Array.from(e).map((async(e,t)=>{const o=e.querySelector(".canvas-content");let r="";if(o){const e=document.createElement("div");e.innerHTML=o.innerHTML;const t=[];if(e.querySelectorAll(".card-image, .nav-image").forEach((e=>{if(e.style.backgroundImage){const o=e.style.backgroundImage.match(/url\(['"]?(.*?)['"]?\)/);o&&o[1]&&o[1].startsWith("data:")&&t.push({container:e,imageData:o[1]})}})),t.length>0){(await imageManager.batchProcessImages(t.map((e=>e.imageData)))).forEach(((e,o)=>{const r=t[o].container;r.style.backgroundImage=`url("${e}")`,r.setAttribute("data-image-id",imageManager.generateImageId())}))}const a=["script",".alignment-arrow",".color-swatch-container",".text-alignment-controls",".controls"];e.querySelectorAll(a.join(", ")).forEach((e=>e.remove())),e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((e=>{e.hasAttribute("contenteditable")||e.setAttribute("contenteditable","true")})),r=e.innerHTML}return{index:t+1,content:r,hasTopNav:Boolean(editor.topNavbarAdded),hasBottomNav:Boolean(editor.bottomNavbarAdded)}})));await this.db.collection("project").doc(this.currentProject.id).update({canvases:r,last_edited:firebase.firestore.FieldValue.serverTimestamp(),lastSavedTimestamp:t}),console.log("Canvases saved successfully")}catch(e){console.error("Error saving canvases:",e),console.error("Error details:",{code:e.code,message:e.message,stack:e.stack})}else console.log("No user logged in or no project selected, or no content changed")}async loadProject(e){try{if(!e)throw new Error("No project ID provided");const t=await this.db.collection("project").doc(e).get();if(!t.exists)return void this.showNotification("Project not found","error");const o=t.data(),r=document.querySelector("#project-title h3");r&&(r.textContent=o.project_name,r.style.display="block"),this.currentProject={id:e,name:o.project_name},await this.loadSavedCanvases(e),hideModal("projects-modal"),this.showNotification("Project loaded successfully")}catch(e){console.error("Error loading project:",e),this.showNotification("Error loading project","error")}}setupAutoSave(){this.autosaveInterval&&clearInterval(this.autosaveInterval),this.autosaveInterval=setInterval((()=>{this.currentProject&&this.contentChanged&&(this.saveCanvases(),this.contentChanged=!1)}),6500),this.setupChangeDetection()}setupChangeDetection(){let e=null;const t=["controls","component-handle","resize-handle","nav-control","alignment-controls"],o=["opacity","visibility","display","transition","pointer-events","cursor","z-index"],r=()=>{e&&clearTimeout(e),e=setTimeout((()=>{this.contentChanged=!0}),1e3)},a=document.querySelector(".canvas-wrapper");if(!a)return;new MutationObserver((e=>{e.some((e=>{const r=e=>{if(!e||!e.classList)return!1;if(t.some((t=>e.classList.contains(t)||e.closest(`.${t}`))))return!0;const o=e.matches?.('button, .controls *, [class*="handle"]');return!!o};if(r(e.target)||r(e.target.parentElement))return!1;switch(e.type){case"characterData":return e.target.parentElement?.hasAttribute("contenteditable");case"attributes":if("style"===e.attributeName){const t=e.oldValue||"",r=e.target.style.cssText,a=e=>{const t={};return e.split(";").forEach((e=>{const[r,a]=e.split(":").map((e=>e.trim()));r&&!o.some((e=>r.toLowerCase().includes(e.toLowerCase())))&&(t[r]=a)})),t},n=a(t),s=a(r);return Object.keys({...n,...s}).some((e=>n[e]!==s[e]))}return["data-component-type","class","contenteditable"].includes(e.attributeName);case"childList":return Array.from(e.addedNodes).concat(Array.from(e.removedNodes)).some((e=>e.nodeType===Node.TEXT_NODE?e.parentElement?.hasAttribute("contenteditable"):e.nodeType===Node.ELEMENT_NODE&&!r(e)));default:return!1}}))&&(console.log("Significant change detected - debouncing"),r())})).observe(a,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),(()=>{a.addEventListener("click",(e=>{const t=e.target;t.parentElement;(t.classList.contains("duplicate-btn")||t.classList.contains("delete-btn")||t.classList.contains("prev-nav")||t.classList.contains("next-nav"))&&(console.log(`${t.className} action detected`),r())}));a.querySelectorAll(".color-swatch-container").forEach((e=>{e.addEventListener("click",(()=>{console.log("Color selection detected"),r()}))}))})(),a.addEventListener("dragend",(()=>r())),a.addEventListener("drop",(()=>r())),a.addEventListener("click",(e=>{e.target.matches(".delete-btn, .duplicate-btn, .component-btn")&&r()})),this.setupUserInteractionTracking()}setupUserInteractionTracking(){const e=document.querySelector(".canvas-container");if(!e)return;["input","paste","drop","dragend"].forEach((t=>{e.addEventListener(t,(()=>{this.contentChanged=!0}))})),e.addEventListener("click",(e=>{e.target.matches(".delete-btn, .duplicate-btn, .component-btn")&&(this.contentChanged=!0)}))}clearAutoSave(){this.autosaveInterval&&(clearInterval(this.autosaveInterval),this.autosaveInterval=null),this.contentChanged=!1}async loadSavedCanvases(e){try{const t=await this.db.collection("project").doc(e).get();if(!t.exists)return void console.log("No saved project found");const o=t.data();if(console.log("Project data loaded:",o),!o.canvases||!o.canvases.length)return console.log("No saved canvases found, creating a new canvas."),void editor.createNewCanvas();document.querySelectorAll(".canvas-wrapper").forEach((e=>e.remove()));const r=o.canvases.sort(((e,t)=>e.index-t.index));console.log("Found canvases:",r);for(const[e,t]of r.entries()){console.log(`Creating canvas ${e+1}...`),editor.createNewCanvas(),await new Promise((e=>setTimeout(e,50)));const o=document.querySelectorAll(".canvas-wrapper"),r=o[o.length-1];if(!r){console.error("Canvas wrapper not found after creation");continue}const a=r.querySelector(".canvas-content");if(a){if(a.innerHTML=t.content||"",a.querySelectorAll(".card-image, .nav-image").forEach((e=>{const t=e.getAttribute("data-background-image");t&&(e.style.backgroundImage=`url(${t})`,e.removeAttribute("data-background-image"))})),a.querySelectorAll(".icon-container i, .iconContainerClass i").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),showIconPicker(e)}))})),a.querySelectorAll(".delete-btn").forEach((e=>{e.onclick=function(){this.closest(".component-container").remove()}})),a.querySelectorAll(".duplicate-btn").forEach((e=>{e.onclick=function(){const e=this.closest(".component-container");if(e){const t=e.getAttribute("data-component-type");t&&editor.duplicateComponent(e,t)}}})),a.querySelectorAll(".component-container").forEach((e=>{const t=e.querySelector(".component-content");if(t){t.querySelectorAll('[style*="var(--color"]').forEach((t=>{const o=createColorSwatches(t);Array.isArray(o)?o.forEach((t=>{t&&t.children.length>0&&e.insertBefore(t,e.firstChild)})):o&&o.children.length>0&&e.insertBefore(o,e.firstChild)}))}})),t.hasTopNav){console.log("Adding top navbar"),editor.topNavbarAdded=!0;const e=editor.components.navbar();editor.insertNavbar(r,e,"top")}if(t.hasBottomNav){console.log("Adding bottom navbar"),editor.bottomNavbarAdded=!0;const e=editor.components.bottomNav();editor.insertNavbar(r,e,"bottom")}editor.setupImageUpload(a),editor.setupIconPicker(a),editor.initializeSortable(a),a.querySelectorAll(".component-container").forEach((e=>{const t=e.getAttribute("data-component-type"),o=e.querySelector(".component-content");if(t&&o)switch(t&&editor.setupVariantControls(e,o,t),t){case"adjustableSpace":const t=o.querySelector(".blankSpace");t&&editor.copyAdjustableSpaceState(t,t);break;case"icon":const r=o.querySelector(".iconContainerClass");editor.copyIconState(r,r);const a=createAlignmentControls(r);o.iconAlignment=a;break;case"avatar":const n=o.querySelector(".avatar-container"),s=createAlignmentControls(n);o.alignmentControls=s;break;case"notificationBanner":editor.setupNotificationBanner(o);break;case"progressTracker":editor.setupProgressTracker(e);break;case"divider":editor.copyDividerState(o);break;case"chipGroup":editor.setupChipGroup(e);break;case"tabs":editor.setupTabs(e);break;case"accordion":const i=o.querySelector(".accordion-content");editor.initializeSortable(i),editor.setupComponentControls(i);break;case"hzDivider":editor.setupDividerState(o);break;case"colorBlock":const c=o.querySelector(".colorBlock-inner");editor.initializeSortable(c),editor.setupComponentControls(c);break;case"checkbox":const l=o.querySelector(".checkbox-square-icon"),d=o.querySelector(".checkbox-check-icon");l.addEventListener("click",(()=>{d.classList.toggle("checked")}));const u=o.querySelector("span");editor.makeTextEditable(u);break;case"radio":const h=o.querySelector(".custom-radio"),m=h.querySelector("span");h.addEventListener("click",(()=>{document.querySelectorAll(".custom-radio").forEach((e=>{e.querySelector("span").style.display="none",e.style.borderColor="#e0e0e0"})),m.style.display="block",h.style.borderColor="var(--color-primary)"}));const p=o.querySelector('span:not([style*="border-radius"])');editor.makeTextEditable(p);break;case"toggleSwitch":const g=o.querySelector(".toggle-switch"),y=g.querySelector(".toggle-slider"),v=g.querySelector(".toggle-thumb");let b=!1;const f=()=>{b=!b,b?(y.style.backgroundColor="var(--color-primary)",v.style.left="30px"):(y.style.backgroundColor="var(--neutral-gray)",v.style.left="4px")};g.addEventListener("click",f);break;case"slider":const w=o.querySelector(".custom-range-slider"),S=o.querySelector(".range-value");w.addEventListener("input",(()=>{S.textContent=w.value}));break;case"textarea":editor.setupResize(o)}}))}}this.currentProject={id:e,name:o.project_name},console.log("Canvas loading complete"),hideModal("projects-modal"),this.showNotification("Project loaded successfully"),setTimeout((()=>{this.setupAutoSave()}),4e3)}catch(e){console.error("Error loading canvases:",e),this.showNotification("Error loading canvases","error")}}setCurrentProject(e){this.currentProject=e,this.setupAutoSave()}async checkProjectLimit(){try{const e=this.db.collection("project"),t=await e.where("owner","==",this.db.doc(`users/${this.currentUser.uid}`)).get().then((e=>e.size)),o=await this.db.collection("users").doc(this.currentUser.uid).get(),r=o.exists&&!0===o.data().pro_account;return t>=2&&!r?void this.showSubscriptionModal():void this.handleNewProject()}catch(e){console.error("Error checking project limit:",e)}}async loadUserProjects(){try{if(!this.currentUser?.uid)throw new Error("No authenticated user");const e=firebase.firestore().doc(`users/${this.currentUser.uid}`),t=firebase.firestore().collection("project").where("owner","==",e).orderBy("last_edited","desc"),o=(await t.get()).docs;this.displayProjectsList(o)}catch(e){console.error("Error fetching user projects:",e.message)}}displayProjectsList(e){const t=document.querySelector("#projects-container");if(t){if(t.innerHTML="",0===e.length){const e=document.createElement("div");return e.className="no-projects-message",e.innerHTML='\n                <i class="fa-regular fa-folder"></i> &nbsp; <i class="fa-solid fa-exclamation"></i>\n                <h2>No Projects Found</h2>\n                <p>Click "New Project" to get started!</p>\n            ',void t.appendChild(e)}e.forEach((e=>{const o=e.data(),r=document.createElement("div");r.className="project-item",r.innerHTML=`\n                <div class="project-info">\n                    <h3>${o.project_name}</h3>\n                    <span>Last edited: ${o.last_edited?.toDate().toLocaleString()||"N/A"}</span>\n                </div>\n                <div class="project-actions">\n                    ${o.pinned_project?'<i class="fas fa-thumbtack"></i>':""}\n                    <button onclick="projectManager.loadProject('${e.id}')" class="open-btn">\n                        <i class="fas fa-folder-open"></i> Open\n                    </button>\n                </div>\n            `,t.appendChild(r)}))}else console.warn("Projects container not found in DOM")}showNotification(e,t="success"){const o=document.createElement("div");o.className=`notification ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.remove()}),3e3)}}const projectManager=new ProjectManager;function showModal(e){document.getElementById(e).style.display="flex"}function hideModal(e){document.getElementById(e).style.display="none"}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("open-projects-btn");e&&e.addEventListener("click",(()=>showModal("projects-modal"))),document.querySelectorAll(".close-modal").forEach((e=>{e.addEventListener("click",(()=>{const t=e.closest(".modal");t&&hideModal(t.id)}))})),document.querySelectorAll(".modal").forEach((e=>{e.addEventListener("click",(t=>{t.target===e&&hideModal(e.id)}))}))})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(document.querySelector(".modal-overlay").style.display="none",document.querySelectorAll(".modal").forEach((e=>{"flex"===e.style.display&&hideModal(e.id)})))})),firebase.auth().onAuthStateChanged((async e=>{if(e)try{(await firebase.firestore().collection("users").doc(e.uid).get()).exists||await firebase.firestore().collection("users").doc(e.uid).set({display_name:e.displayName||e.email,photo_url:e.photoURL||"https://firebasestorage.googleapis.com/v0/b/experience-builder-m-v-wxacv7.appspot.com/o/avatar-placeholder.png?alt=media&token=6e0896e6-0285-46d9-b251-6b8ee8f690f4",email:e.email,created_time:e.createdTime||firebase.firestore.FieldValue.serverTimestamp(),last_active_time:firebase.firestore.FieldValue.serverTimestamp(),logged_in:!0}),document.querySelector(".user-profile-section").innerHTML=`\n                <div class="user-info">\n                    <img src="${e.photoURL||"https://firebasestorage.googleapis.com/v0/b/experience-builder-m-v-wxacv7.appspot.com/o/avatar-placeholder.png?alt=media&token=6e0896e6-0285-46d9-b251-6b8ee8f690f4"}" \n                         alt="Profile" \n                         class="profile-photo">\n                    <span>${e.displayName||e.email}</span>\n                </div>\n                <button onclick="firebase.auth().signOut()" class="logout-btn">\n                    <i class="fas fa-sign-out-alt"></i>\n                </button>\n            `,document.querySelector(".user-profile-section").style.display="flex",document.querySelector("#open-projects-btn").style.display="block",document.querySelector(".login-button").style.display="none",document.querySelector("#auth-modal").style.display="none"}catch(e){console.error("Error handling auth state:",e)}else document.querySelector(".user-profile-section").style.display="none",document.querySelector(".login-button").style.display="flex",document.querySelector("#open-projects-btn").style.display="none",document.querySelector("#projects-modal").style.display="none"}));