const{defineString:defineString}=require("firebase-functions/params"),{onRequest:onRequest,onCall:onCall,HttpsError:HttpsError}=require("firebase-functions/v2/https"),admin=require("firebase-admin"),express=require("express"),cors=require("cors"),bodyParser=require("body-parser"),stripeSecretKey=defineString("STRIPE_SECRET_KEY",{description:"Stripe API Secret Key"}),stripeWebhookSecret=defineString("STRIPE_WEBHOOK_SECRET",{description:"Stripe Webhook Signing Secret"}),appUrl=defineString("APP_URL",{description:"Application URL",default:"https://dlightning.org"});admin.initializeApp();const stripe=require("stripe")(stripeSecretKey.value()),db=admin.firestore(),app=express();app.use(cors({origin:!0}));const validateWebhookSignature=express.raw({type:"application/json"});async function updateUserSubscription(e,t){try{return await db.collection("users").doc(e).update({pro_account:"active"===t.status,subscription_status:t.status,subscription_current_period_end:admin.firestore.Timestamp.fromMillis(1e3*t.current_period_end),subscription_start_date:admin.firestore.Timestamp.fromMillis(1e3*t.start_date),stripe_customer_id:t.customer,stripe_subscription_id:t.id,last_updated:admin.firestore.FieldValue.serverTimestamp()}),console.log(`Updated subscription for user ${e}`),!0}catch(e){return console.error(`Error updating user subscription: ${e.message}`),!1}}async function getUserIdFromCustomerId(e){try{const t=await db.collection("users").where("stripe_customer_id","==",e).limit(1).get();return t.empty?(console.warn(`No user found for Stripe customer: ${e}`),null):t.docs[0].id}catch(e){return console.error(`Error finding user for customer: ${e.message}`),null}}async function createStripeCustomer(e){try{const t=await stripe.customers.create({email:e.email,name:e.displayName||e.email,metadata:{firebaseUID:e.uid}});return await db.collection("users").doc(e.uid).update({stripe_customer_id:t.id}),t.id}catch(e){throw console.error(`Error creating Stripe customer: ${e.message}`),e}}async function getOrCreateCustomerId(e){const t=await db.collection("users").doc(e).get();if(!t.exists)throw new Error(`User with ID ${e} not found`);const r=t.data();if(r.stripe_customer_id)return r.stripe_customer_id;return createStripeCustomer(await admin.auth().getUser(e))}async function logPaymentActivity(e,t){try{await db.collection("payment_logs").add({user_id:e,payment_intent:t.payment_intent,payment_status:t.status,amount:t.amount_paid/100,currency:t.currency,invoice:t.invoice,subscription:t.subscription,timestamp:admin.firestore.FieldValue.serverTimestamp()})}catch(e){console.error(`Error logging payment: ${e.message}`)}}app.post("/createCheckoutSession",(async(e,t)=>{try{const r=e.headers.authorization;if(!r||!r.startsWith("Bearer "))return t.status(401).json({error:"Unauthorized"});const s=r.split("Bearer ")[1],o=(await admin.auth().verifyIdToken(s)).uid,{priceId:a,successUrl:i,cancelUrl:n}=e.body;if(!a||!i||!n)return t.status(400).json({error:"Missing required parameters"});const c=await getOrCreateCustomerId(o),u=await stripe.checkout.sessions.create({payment_method_types:["card"],customer:c,line_items:[{price:a,quantity:1}],mode:"subscription",success_url:i,cancel_url:n,allow_promotion_codes:!0,metadata:{firebaseUID:o}});return t.status(200).json({url:u.url})}catch(e){return console.error("Error creating checkout session:",e),t.status(500).json({error:e.message})}})),app.post("/createPortalSession",(async(e,t)=>{try{const r=e.headers.authorization;if(!r||!r.startsWith("Bearer "))return t.status(401).json({error:"Unauthorized"});const s=r.split("Bearer ")[1],o=(await admin.auth().verifyIdToken(s)).uid,{returnUrl:a}=e.body;if(!a)return t.status(400).json({error:"Missing return URL"});const i=await db.collection("users").doc(o).get();if(!i.exists)return t.status(404).json({error:"User not found"});const n=i.data();if(!n.stripe_customer_id)return t.status(400).json({error:"No subscription found for this user"});const c=await stripe.billingPortal.sessions.create({customer:n.stripe_customer_id,return_url:a});return t.status(200).json({url:c.url})}catch(e){return console.error("Error creating portal session:",e),t.status(500).json({error:e.message})}})),app.post("/checkSubscriptionStatus",(async(e,t)=>{try{const r=e.headers.authorization;if(!r||!r.startsWith("Bearer "))return t.status(401).json({error:"Unauthorized"});const s=r.split("Bearer ")[1],o=(await admin.auth().verifyIdToken(s)).uid,a=await db.collection("users").doc(o).get();if(!a.exists)return t.status(404).json({error:"User not found"});const i=a.data(),n={isActive:Boolean(i.pro_account),status:i.subscription_status||"none",currentPeriodEnd:i.subscription_current_period_end?.toDate()||null,customerId:i.stripe_customer_id||null,subscriptionId:i.stripe_subscription_id||null};return t.status(200).json(n)}catch(e){return console.error("Error checking subscription status:",e),t.status(500).json({error:e.message})}})),app.post("/webhook",validateWebhookSignature,(async(e,t)=>{const r=e.headers["stripe-signature"];try{const s=stripe.webhooks.constructEvent(e.body,r,stripeWebhookSecret.value());switch(console.log(`Received webhook event: ${s.type}`),s.type){case"customer.subscription.created":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await updateUserSubscription(t,e),"active"===e.status&&await db.collection("users").doc(t).update({pro_account:!0,last_payment_date:admin.firestore.FieldValue.serverTimestamp(),last_payment_status:"succeeded"}));break}case"customer.subscription.updated":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await updateUserSubscription(t,e),await db.collection("users").doc(t).update({pro_account:"active"===e.status}));break}case"customer.subscription.deleted":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await updateUserSubscription(t,e),await db.collection("users").doc(t).update({pro_account:!1}));break}case"invoice.payment_succeeded":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&e.subscription&&(await logPaymentActivity(t,e),await db.collection("users").doc(t).update({last_payment_date:admin.firestore.Timestamp.fromMillis(1e3*e.created),last_payment_status:"succeeded",last_payment_amount:e.amount_paid/100}));break}case"invoice.payment_failed":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await logPaymentActivity(t,e),await db.collection("users").doc(t).update({last_payment_date:admin.firestore.Timestamp.fromMillis(1e3*e.created),last_payment_status:"failed"}));break}}return t.status(200).json({received:!0})}catch(e){return console.error(`Webhook error: ${e.message}`),t.status(400).json({error:e.message})}})),exports.createCheckoutSession=onCall({cors:!0},(async(e,t)=>{if(!t.auth)throw new HttpsError("unauthenticated","User must be logged in");const r=t.auth.uid,{priceId:s,successUrl:o,cancelUrl:a}=e;if(!s||!o||!a)throw new HttpsError("invalid-argument","Missing required parameters");try{const e=await getOrCreateCustomerId(r);return{url:(await stripe.checkout.sessions.create({payment_method_types:["card"],customer:e,line_items:[{price:s,quantity:1}],mode:"subscription",success_url:o,cancel_url:a,allow_promotion_codes:!0,metadata:{firebaseUID:r}})).url}}catch(e){throw console.error("Error creating checkout session:",e),new HttpsError("internal",e.message)}})),exports.createPortalSession=onCall({cors:!0},(async(e,t)=>{if(!t.auth)throw new HttpsError("unauthenticated","User must be logged in");const r=t.auth.uid,{returnUrl:s}=e;if(!s)throw new HttpsError("invalid-argument","Missing return URL");try{const e=await db.collection("users").doc(r).get();if(!e.exists)throw new HttpsError("not-found","User not found");const t=e.data();if(!t.stripe_customer_id)throw new HttpsError("failed-precondition","No subscription found for this user");return{url:(await stripe.billingPortal.sessions.create({customer:t.stripe_customer_id,return_url:s})).url}}catch(e){throw console.error("Error creating portal session:",e),new HttpsError("internal",e.message)}})),exports.checkSubscriptionStatus=onCall({cors:!0},(async(e,t)=>{if(!t.auth)throw new HttpsError("unauthenticated","User must be logged in");const r=t.auth.uid;try{const e=await db.collection("users").doc(r).get();if(!e.exists)throw new HttpsError("not-found","User not found");const t=e.data();return{isActive:Boolean(t.pro_account),status:t.subscription_status||"none",currentPeriodEnd:t.subscription_current_period_end||null,customerId:t.stripe_customer_id||null,subscriptionId:t.stripe_subscription_id||null}}catch(e){throw console.error("Error checking subscription status:",e),new functions.https.HttpsError("internal",e.message)}})),exports.stripeWebhook=onRequest({cors:!0},(async(e,t)=>{const r=e.headers["stripe-signature"];try{if(!e.rawBody)throw new Error("Missing raw request body");const s=stripe.webhooks.constructEvent(e.rawBody,r,stripeWebhookSecret.value());switch(console.log(`Received webhook event: ${s.type}`),s.type){case"customer.subscription.created":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await updateUserSubscription(t,e),"active"===e.status&&await db.collection("users").doc(t).update({pro_account:!0,last_payment_date:admin.firestore.FieldValue.serverTimestamp(),last_payment_status:"succeeded"}));break}case"customer.subscription.updated":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await updateUserSubscription(t,e),await db.collection("users").doc(t).update({pro_account:"active"===e.status}));break}case"customer.subscription.deleted":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await updateUserSubscription(t,e),await db.collection("users").doc(t).update({pro_account:!1}));break}case"invoice.payment_succeeded":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&e.subscription&&(await logPaymentActivity(t,e),await db.collection("users").doc(t).update({last_payment_date:admin.firestore.Timestamp.fromMillis(1e3*e.created),last_payment_status:"succeeded",last_payment_amount:e.amount_paid/100}));break}case"invoice.payment_failed":{const e=s.data.object,t=await getUserIdFromCustomerId(e.customer);t&&(await logPaymentActivity(t,e),await db.collection("users").doc(t).update({last_payment_date:admin.firestore.Timestamp.fromMillis(1e3*e.created),last_payment_status:"failed"}));break}}return t.status(200).json({received:!0})}catch(e){return console.error(`Webhook error: ${e.message}`),t.status(400).json({error:e.message})}})),exports.api=onRequest({cors:!0},app);